@{
    Layout = "~/Areas/Public/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Quên mật khẩu";
}

<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-6">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">Quên mật khẩu</h3>
                </div>
                <div class="card-body">
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            @TempData["Error"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }
                    @if (TempData["Message"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["Message"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <!-- Step 1: Nhập số điện thoại và email để gửi OTP -->
                    <div id="step1">
                        <h5 class="mb-3">Bước 1: Nhập thông tin tài khoản</h5>
                        <form id="generateOtpForm">
                            @Html.AntiForgeryToken()
                            <div class="mb-3">
                                <label for="phone" class="form-label">Số điện thoại <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="phone" name="phone" required 
                                       placeholder="Nhập số điện thoại đã đăng ký" />
                            </div>
                            <div class="mb-3">
                                <label for="email" class="form-label">Email nhận mã OTP <span class="text-danger">*</span></label>
                                <input type="email" class="form-control" id="email" name="email" required 
                                       placeholder="Nhập email để nhận mã OTP" />
                                <small class="text-muted">Mã OTP sẽ được gửi đến email này.</small>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                Gửi mã OTP qua email
                            </button>
                        </form>
                    </div>

                    <!-- Step 2: Nhập OTP và mật khẩu mới -->
                    <div id="step2" style="display: none;">
                        <h5 class="mb-3">Bước 2: Nhập mã OTP và mật khẩu mới</h5>
                        <form id="resetPasswordForm">
                            @Html.AntiForgeryToken()
                            <input type="hidden" id="resetPhone" name="phone" />
                            <div class="mb-3">
                                <label for="otp" class="form-label">Mã OTP <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="otp" name="otp" required 
                                       placeholder="Nhập mã OTP 6 chữ số" maxlength="6" />
                                <small class="text-muted">Mã OTP đã được gửi đến email của bạn. Vui lòng kiểm tra hộp thư.</small>
                            </div>
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">Mật khẩu mới <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" id="newPassword" name="newPassword" required 
                                       placeholder="Nhập mật khẩu mới" />
                            </div>
                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">Xác nhận mật khẩu <span class="text-danger">*</span></label>
                                <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" required 
                                       placeholder="Nhập lại mật khẩu mới" />
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" class="btn btn-secondary" onclick="backToStep1()">Quay lại</button>
                                <button type="submit" class="btn btn-primary flex-grow-1">Đặt lại mật khẩu</button>
                            </div>
                        </form>
                    </div>

                    <hr class="my-4">
                    <div class="text-center">
                        <a asp-area="Public" asp-controller="Customer" asp-action="Login" class="text-decoration-none">
                            ← Quay lại đăng nhập
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    let receivedOtp = '';

    document.getElementById('generateOtpForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const phone = document.getElementById('phone').value.trim();
        const email = document.getElementById('email').value.trim();
        
        if (!phone) {
            alert('Vui lòng nhập số điện thoại.');
            return;
        }

        if (!email) {
            alert('Vui lòng nhập email.');
            return;
        }

        // Disable button để tránh double submit
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Đang gửi...';

        try {
            const response = await fetch('@Url.Action("GenerateOtp", "Customer", new { area = "Public" })', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                },
                body: JSON.stringify({ phone: phone, email: email })
            });

            const data = await response.json();
            
            if (data.success) {
                document.getElementById('resetPhone').value = phone;
                document.getElementById('step1').style.display = 'none';
                document.getElementById('step2').style.display = 'block';
                alert('Mã OTP đã được gửi đến email: ' + email + '. Vui lòng kiểm tra hộp thư.');
            } else {
                alert('Lỗi: ' + (data.error || 'Không thể tạo OTP'));
            }
        } catch (error) {
            alert('Lỗi kết nối: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Gửi mã OTP qua email';
        }
    });

    document.getElementById('resetPasswordForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const phone = document.getElementById('resetPhone').value;
        const otp = document.getElementById('otp').value.trim();
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;

        if (newPassword !== confirmPassword) {
            alert('Mật khẩu xác nhận không khớp.');
            return;
        }

        if (newPassword.length < 6) {
            alert('Mật khẩu phải có ít nhất 6 ký tự.');
            return;
        }

        try {
            const response = await fetch('@Url.Action("ResetPassword", "Customer", new { area = "Public" })', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('#resetPasswordForm input[name="__RequestVerificationToken"]')?.value
                },
                body: JSON.stringify({
                    phone: phone,
                    otp: otp,
                    newPassword: newPassword
                })
            });

            const data = await response.json();
            
            if (data.success) {
                alert('Đặt lại mật khẩu thành công! Vui lòng đăng nhập lại.');
                window.location.href = '@Url.Action("Login", "Customer", new { area = "Public" })';
            } else {
                alert('Lỗi: ' + (data.error || 'Không thể đặt lại mật khẩu'));
            }
        } catch (error) {
            alert('Lỗi kết nối: ' + error.message);
        }
    });

    function backToStep1() {
        document.getElementById('step1').style.display = 'block';
        document.getElementById('step2').style.display = 'none';
        receivedOtp = '';
    }
</script>
}

