@using Microsoft.AspNetCore.Http
@inject IHttpContextAccessor HttpContextAccessor
@{
    var username = Context.Session.GetString("CUsername");
    var sessionId = HttpContextAccessor.HttpContext.Session.GetString("CSessionId");
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - KLTN</title>
    <!-- Bootstrap CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <header>
        <nav class="navbar navbar-expand-sm navbar-light bg-light border-bottom mb-3">
            <div class="container-fluid">
                <a class="navbar-brand" asp-area="" asp-controller="Home" asp-action="Index">KLTN</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent"
                        aria-controls="navbarContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse d-sm-flex justify-content-between" id="navbarContent">
                    <!-- Menu trái -->
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" asp-area="Public" asp-controller="Home" asp-action="Index">Home</a>
                        </li>
                        @if (!string.IsNullOrEmpty(username))
                        {
                            <li class="nav-item">
                                <a class="nav-link" asp-area="Public" asp-controller="Appointment" asp-action="Booking">Đặt lịch</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" asp-area="Public" asp-controller="Appointment" asp-action="Index">Xem lịch đặt</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" asp-area="Public" asp-controller="Order" asp-action="Index">Xem đơn hàng</a>
                            </li>
                        }
                        <li class="nav-item">
                            <a class="nav-link" asp-area="Public" asp-controller="Help" asp-action="Index">Trợ giúp</a>
                        
                        </li>
                    </ul>

                    <!-- Menu phải -->
                    <ul class="navbar-nav">
                        @if (string.IsNullOrEmpty(username))
                        {
                            <li class="nav-item">
                                <a class="nav-link" asp-area="Public" asp-controller="Customer" asp-action="Login">Login</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" asp-area="Public" asp-controller="Customer" asp-action="Register">Register</a>
                            </li>
                        }
                        else
                        {
                            <li class="nav-item">
                                <a class="nav-link" asp-area="Public" asp-controller="Customer" asp-action="ChangePassword">Đổi mật khẩu</a>
                            </li>
                            <li class="nav-item">
                                <form method="post" asp-area="Public" asp-controller="Customer" asp-action="Logout">
                                    <button type="submit" class="nav-link btn btn-link text-start">Logout (@username)</button>
                                </form>
                            </li>

                        }
                        
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <main class="container pb-3">
        @RenderBody()
    </main>

    <!-- Floating FAQ Chatbot Button -->
    @{
        var isHelpPage = ViewContext.RouteData.Values["controller"]?.ToString() == "Help";
    }
    @if (!isHelpPage)
    {
        <button id="faqToggleBtn" class="btn btn-info btn-lg rounded-circle shadow-lg position-fixed" 
                style="bottom: 20px; right: 20px; width: 60px; height: 60px; z-index: 1050;"
                onclick="toggleFaqModal()">
            💡
        </button>

        <!-- FAQ Modal -->
        <div id="faqModal" class="position-fixed shadow-lg" style="display: none; bottom: 90px; right: 20px; width: 380px; max-width: 90vw; z-index: 1050; background: white; border-radius: 10px; overflow: hidden;">
            <div class="card border-0 h-100 d-flex flex-column" style="max-height: 600px;">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">💡 Trợ giúp nhanh</h5>
                    <div>
                        <button class="btn btn-sm btn-light" onclick="closeFaqModal()" title="Đóng">
                            ×
                        </button>
                    </div>
                </div>
                <div id="faqModalBody" class="card-body flex-grow-1 d-flex flex-column" style="overflow: hidden;">
                    <div class="mb-3">
                        <input type="text" class="form-control form-control-sm" id="faqSearch" 
                               placeholder="Tìm câu hỏi...">
                    </div>
                    <div id="faqList" class="flex-grow-1" style="overflow-y: auto; max-height: 400px;">
                        <div class="text-center text-muted">
                            <small>Đang tải...</small>
                        </div>
                    </div>
                    <hr class="my-2">
                    <a href="@Url.Action("Index", "Help", new { area = "Public" })" 
                       class="btn btn-sm btn-outline-primary w-100">
                        📧 Gửi yêu cầu trợ giúp
                    </a>
                </div>
            </div>
        </div>
    }

    <footer class="border-top text-muted py-3">
        <div class="container">
            &copy; 2025 - KLTN - <a asp-area="" asp-controller="Home" asp-action="Privacy">Privacy</a>
        </div>
    </footer>

    <!-- Bootstrap JS CDN -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    @RenderSection("Scripts", required: false)
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
    <script>
            // Lấy username từ Razor, đảm bảo không null
            const username = '@(username ?? "")';
            const sessionId = '@(HttpContextAccessor.HttpContext.Session.GetString("CSessionId") ?? "")';
            console.log('👤 sessionId:', sessionId);
            // Tạo SignalR connection
            @inject IConfiguration Configuration
            const connection = new signalR.HubConnectionBuilder()
        .withUrl('@Configuration["SignalR:NotificationHubUrl"]?sessionId=' + encodeURIComponent(sessionId))
        .withAutomaticReconnect()
        .build();
        const dashboardUrl = '@Url.Action("Index", "Home", new { area = "Public" })';

            // Lắng nghe ForceLogout từ server
            connection.on('ForceLogout', async function(message) {
            const logoutUrl = '@Url.Action("Logout", "Customer", new { area = "Public" })';
            const loginUrl = '@Url.Action("Login", "Customer", new { area = "Public" })';

            try {
                await fetch(logoutUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value
                    }
                });
            } catch (err) {
                console.error('Logout request failed', err);
            } finally {
                // Chuyển về login
                window.location.href = loginUrl;
            }
        });


            // Start SignalR connection
            async function startConnection() {
                try {
                    await connection.start();
                    console.log('✅ SignalR connected');
                } catch (err) {
                    console.error('⚠️ SignalR start error:', err);
                    setTimeout(startConnection, 5000); // thử lại sau 5s
                }
            }

            startConnection();

            // 🔐 Đồng bộ login/logout đa tab
            const channel = new BroadcastChannel('Cauth_channel');

                    channel.onmessage = (event) => {
            console.log('📢 Nhận auth event từ tab khác:', event.data);
            if (event.data === 'logout') {
                setTimeout(() => {
                    window.location.href = loginUrl;
                }, 1000); // 1000 ms = 1 giây
            } else if (event.data === 'login') {
                setTimeout(() => {
                    window.location.href = dashboardUrl;
                }, 1000);
                
            }
        };


            // Gửi sự kiện logout từ form
            const logoutForm = document.querySelector('form[action$="Logout"]');
            if (logoutForm) {
                logoutForm.addEventListener('submit', () => {
                    channel.postMessage('logout');
                    console.log('📡 Gửi logout event sang các tab khác');
                });
            }

                    const loginLink = document.querySelector('form[action$="Login"]');
        if (loginLink) {
            loginLink.addEventListener('click', () => {
                channel.postMessage('login');
                console.log('📡 Gửi login event sang các tab khác');
            });
        }

        // FAQ Floating Modal Helper
        let faqModalMinimized = false;
        let faqModalVisible = false;

        function toggleFaqModal() {
            const modal = document.getElementById('faqModal');
            if (!modal) return;
            
            if (faqModalVisible) {
                closeFaqModal();
            } else {
                openFaqModal();
            }
        }

        function openFaqModal() {
            const modal = document.getElementById('faqModal');
            const modalBody = document.getElementById('faqModalBody');
            if (!modal || !modalBody) return;
            
            modal.style.display = 'block';
            modalBody.style.display = 'flex';
            faqModalMinimized = false;
            faqModalVisible = true;
            document.getElementById('minimizeIcon').textContent = '−';
            
            // Load FAQs if not already loaded
            const faqList = document.getElementById('faqList');
            if (faqList && (!window.faqLoaded || faqList.innerHTML.includes('Đang tải'))) {
                window.loadFaqsIfNeeded();
            }
        }

        function minimizeFaqModal() {
            const modal = document.getElementById('faqModal');
            const modalBody = document.getElementById('faqModalBody');
            if (!modal || !modalBody) return;
            
            if (faqModalMinimized) {
                // Maximize
                modalBody.style.display = 'flex';
                faqModalMinimized = false;
                document.getElementById('minimizeIcon').textContent = '−';
            } else {
                // Minimize
                modalBody.style.display = 'none';
                faqModalMinimized = true;
                document.getElementById('minimizeIcon').textContent = '+';
            }
        }

        function closeFaqModal() {
            const modal = document.getElementById('faqModal');
            if (!modal) return;
            
            modal.style.display = 'none';
            faqModalVisible = false;
            faqModalMinimized = false;
        }

        // FAQ Auto Helper
        (async function() {
            const faqList = document.getElementById('faqList');
            const faqSearch = document.getElementById('faqSearch');
            let allFaqs = [];
            window.faqLoaded = false;

            async function loadFaqs() {
                try {
                    const response = await fetch('@Url.Action("GetFaqs", "Help", new { area = "Public" })');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();
                    console.log('FAQ Data received:', data); // Debug log
                    // Try both lowercase and uppercase property names
                    allFaqs = data.faqs || data.Faqs || [];
                    console.log('FAQ items loaded:', allFaqs.length); // Debug log
                    renderFaqs(allFaqs);
                    window.faqLoaded = true;
                } catch (error) {
                    console.error('Lỗi tải FAQ:', error);
                    if (faqList) {
                        faqList.innerHTML = '<div class="text-danger small">Không thể tải câu hỏi thường gặp: ' + error.message + '</div>';
                    }
                }
            }

            function renderFaqs(faqs) {
                if (!faqList) return;
                
                if (faqs.length === 0) {
                    faqList.innerHTML = '<div class="text-muted small">Không có câu hỏi nào.</div>';
                    return;
                }

                // Generate unique IDs based on timestamp to avoid conflicts
                const timestamp = Date.now();
                faqList.innerHTML = faqs.map((faq, index) => {
                    const faqId = `faq_${timestamp}_${index}`;
                    return `
                        <div class="mb-3">
                            <button class="btn btn-link text-start p-0 w-100 text-decoration-none" 
                                    type="button" data-bs-toggle="collapse" 
                                    data-bs-target="#${faqId}" aria-expanded="false">
                                <strong class="text-primary">❓ ${faq.question}</strong>
                            </button>
                            <div class="collapse" id="${faqId}">
                                <div class="card card-body border-0 bg-light small mt-2">
                                    ${faq.answer}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            if (faqSearch) {
                faqSearch.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    if (searchTerm === '') {
                        renderFaqs(allFaqs);
                    } else {
                        const filtered = allFaqs.filter(faq => 
                            faq.question.toLowerCase().includes(searchTerm) ||
                            faq.answer.toLowerCase().includes(searchTerm)
                        );
                        renderFaqs(filtered);
                    }
                });
            }

            // Make loadFaqs available globally
            window.loadFaqsIfNeeded = async function() {
                if (!window.faqLoaded) {
                    await loadFaqs();
                }
            };
            
            // Auto load on page load
            await loadFaqs();
        })();
    </script>

</body>
</html>
