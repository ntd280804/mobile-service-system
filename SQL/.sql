--------------------------------------------------------
--  File created - Monday-November-10-2025   
--------------------------------------------------------
DROP TYPE "APP"."ODCIVARCHAR2LIST_ARRAY";
DROP SEQUENCE "APP"."APPOINTMENT_SEQ";
DROP SEQUENCE "APP"."ORDERS_SEQ";
DROP SEQUENCE "APP"."PART_REQUEST_ITEM_SEQ";
DROP SEQUENCE "APP"."PART_REQUEST_SEQ";
DROP SEQUENCE "APP"."PART_SEQ";
DROP SEQUENCE "APP"."STOCKIN_ITEM_SEQ";
DROP SEQUENCE "APP"."STOCKIN_SEQ";
DROP SEQUENCE "APP"."STOCKOUT_SEQ";
DROP TABLE "APP"."CREATE$JAVA$LOB$TABLE" cascade constraints;
DROP TABLE "APP"."CUSTOMER" cascade constraints;
DROP TABLE "APP"."CUSTOMER_APPOINTMENT" cascade constraints;
DROP TABLE "APP"."EMPLOYEE" cascade constraints;
DROP TABLE "APP"."EMPLOYEE_SHIFT" cascade constraints;
DROP TABLE "APP"."INVOICE" cascade constraints;
DROP TABLE "APP"."INVOICE_ITEM" cascade constraints;
DROP TABLE "APP"."INVOICE_SERVICE" cascade constraints;
DROP TABLE "APP"."ORDERS" cascade constraints;
DROP TABLE "APP"."ORDER_SERVICE" cascade constraints;
DROP TABLE "APP"."PART" cascade constraints;
DROP TABLE "APP"."PART_REQUEST" cascade constraints;
DROP TABLE "APP"."PART_REQUEST_ITEM" cascade constraints;
DROP TABLE "APP"."SERVICE" cascade constraints;
DROP TABLE "APP"."STOCK_IN" cascade constraints;
DROP TABLE "APP"."STOCK_IN_ITEM" cascade constraints;
DROP TABLE "APP"."STOCK_OUT" cascade constraints;
DROP TABLE "APP"."STOCK_OUT_ITEM" cascade constraints;
DROP TABLE "APP"."USER_OTP_LOG" cascade constraints;
DROP PROCEDURE "APP"."ACCEPT_PART_REQUEST";
DROP PROCEDURE "APP"."ASSIGN_PROFILE_TO_USER";
DROP PROCEDURE "APP"."ASSIGN_ROLE_PROC";
DROP PROCEDURE "APP"."COMPLETE_PART_REQUEST";
DROP PROCEDURE "APP"."CREATE_APPOINTMENT";
DROP PROCEDURE "APP"."CREATE_ORDER";
DROP PROCEDURE "APP"."CREATE_ORDER_SERVICE";
DROP PROCEDURE "APP"."CREATE_PART";
DROP PROCEDURE "APP"."CREATE_PART_REQUEST";
DROP PROCEDURE "APP"."CREATE_PART_REQUEST_ITEM";
DROP PROCEDURE "APP"."CREATE_PROFILE";
DROP PROCEDURE "APP"."CREATE_ROLE_PROC";
DROP PROCEDURE "APP"."CREATE_STOCKIN";
DROP PROCEDURE "APP"."CREATE_STOCKIN_ITEM";
DROP PROCEDURE "APP"."CREATE_STOCKOUT_TRANSACTION";
DROP PROCEDURE "APP"."DELETE_PROFILE";
DROP PROCEDURE "APP"."DELETE_ROLE_PROC";
DROP PROCEDURE "APP"."DENY_PART_REQUEST";
DROP PROCEDURE "APP"."GET_ALL_APPOINTMENTS";
DROP PROCEDURE "APP"."GET_ALL_CUSTOMERS";
DROP PROCEDURE "APP"."GET_ALL_EMPLOYEES";
DROP PROCEDURE "APP"."GET_ALL_EXPORTS";
DROP PROCEDURE "APP"."GET_ALL_IMPORTS";
DROP PROCEDURE "APP"."GET_ALL_ORDERS";
DROP PROCEDURE "APP"."GET_ALL_PART";
DROP PROCEDURE "APP"."GET_ALL_PART_IN_STOCK";
DROP PROCEDURE "APP"."GET_ALL_PART_REQUESTS";
DROP PROCEDURE "APP"."GET_ALL_PROFILES_WITH_LIMITS";
DROP PROCEDURE "APP"."GET_ALL_ROLES";
DROP PROCEDURE "APP"."GET_ALL_SERVICES";
DROP PROCEDURE "APP"."GET_ALL_USERS";
DROP PROCEDURE "APP"."GET_ALL_USERS_WITH_PROFILE";
DROP PROCEDURE "APP"."GET_BY_ORDER_TYPE";
DROP PROCEDURE "APP"."GET_EMPLOYEE_BY_ID";
DROP PROCEDURE "APP"."GET_EMPLOYEE_ID_BY_USERNAME";
DROP PROCEDURE "APP"."GET_EMPLOYEE_NAME_BY_ID";
DROP PROCEDURE "APP"."GET_EMPLOYEE_PUBLIC_KEY";
DROP PROCEDURE "APP"."GET_EMP_ID_FROM_STOCKIN";
DROP PROCEDURE "APP"."GET_EMP_ID_FROM_STOCKOUT";
DROP PROCEDURE "APP"."GET_EXPORT_BY_ID";
DROP PROCEDURE "APP"."GET_IMPORT_BY_ID";
DROP PROCEDURE "APP"."GET_ORDER_BY_ID";
DROP PROCEDURE "APP"."GET_PART_BY_ORDERID";
DROP PROCEDURE "APP"."GET_PART_BY_SERIAL";
DROP PROCEDURE "APP"."GET_PART_BY_STATUS";
DROP PROCEDURE "APP"."GET_PART_BY_STOCK";
DROP PROCEDURE "APP"."GET_PART_BY_STOCKINID";
DROP PROCEDURE "APP"."GET_PROFILE_BY_NAME";
DROP PROCEDURE "APP"."GET_ROLES_OF_USER";
DROP PROCEDURE "APP"."GET_SERVICES_BY_ORDER_ID";
DROP PROCEDURE "APP"."GET_STOCKIN_SIGNATURE";
DROP PROCEDURE "APP"."GET_STOCKOUT_SIGNATURE";
DROP PROCEDURE "APP"."GET_UNFINISHED_ORDERS";
DROP PROCEDURE "APP"."LOCK_DB_USER";
DROP PROCEDURE "APP"."LOGIN_CUSTOMER";
DROP PROCEDURE "APP"."LOGIN_EMPLOYEE";
DROP PROCEDURE "APP"."REGISTER_CUSTOMER";
DROP PROCEDURE "APP"."REGISTER_EMPLOYEE";
DROP PROCEDURE "APP"."REVOKE_ROLE_PROC";
DROP PROCEDURE "APP"."SIGN_STOCKIN";
DROP PROCEDURE "APP"."SIGN_STOCKOUT";
DROP PROCEDURE "APP"."UNLOCK_DB_USER";
DROP PROCEDURE "APP"."UPDATE_ORDER_STATUS_WAIT_PART";
DROP PROCEDURE "APP"."UPDATE_STOCKIN_SIGNATURE";
DROP PROCEDURE "APP"."UPDATE_STOCKOUT_SIGNATURE";
DROP PROCEDURE "APP"."VERIFY_STOCKIN_SIGNATURE";
DROP PROCEDURE "APP"."VERIFY_STOCKOUT_SIGNATURE";
DROP PACKAGE "APP"."APP_CTX_PKG";
DROP PACKAGE "APP"."CRYPTO";
DROP PACKAGE BODY "APP"."APP_CTX_PKG";
DROP FUNCTION "APP"."APPOINTMENT_VPD_PREDICATE";
DROP FUNCTION "APP"."APPOINTMENT_VPD_PREDICATE_DEL";
DROP FUNCTION "APP"."CUSTOMER_VPD_PREDICATE";
DROP FUNCTION "APP"."EMPLOYEE_VPD_PREDICATE";
DROP FUNCTION "APP"."GET_EMPLOYEE_ROLES_BY_USERNAME";
DROP FUNCTION "APP"."HASH_PASSWORD";
DROP FUNCTION "APP"."HASH_PASSWORD_20CHARS";
DROP FUNCTION "APP"."INVOICE_VPD_PREDICATE";
DROP FUNCTION "APP"."ORDERS_VPD_PREDICATE";
DROP FUNCTION "APP"."ORDERS_VPD_PREDICATE_DEL";
DROP FUNCTION "APP"."ORDERS_VPD_PREDICATE_UPD";
DROP FUNCTION "APP"."PARTREQUEST_VPD_PREDICATE";
DROP FUNCTION "APP"."PART_VPD_PREDICATE";
DROP FUNCTION "APP"."STOCK_VPD_PREDICATE";
--------------------------------------------------------
--  DDL for Type ODCIVARCHAR2LIST_ARRAY
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TYPE "APP"."ODCIVARCHAR2LIST_ARRAY" AS TABLE OF VARCHAR2(4000);

/
--------------------------------------------------------
--  DDL for Sequence APPOINTMENT_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "APP"."APPOINTMENT_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 10 NOCACHE  NOORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence ORDERS_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "APP"."ORDERS_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 101 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence PART_REQUEST_ITEM_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "APP"."PART_REQUEST_ITEM_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 13 NOCACHE  NOORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence PART_REQUEST_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "APP"."PART_REQUEST_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 27 NOCACHE  NOORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence PART_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "APP"."PART_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 312 NOCACHE  NOORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence STOCKIN_ITEM_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "APP"."STOCKIN_ITEM_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 315 NOCACHE  NOORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence STOCKIN_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "APP"."STOCKIN_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 37 NOCACHE  NOORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Sequence STOCKOUT_SEQ
--------------------------------------------------------

   CREATE SEQUENCE  "APP"."STOCKOUT_SEQ"  MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 3 NOCACHE  NOORDER  NOCYCLE  NOKEEP  NOSCALE  GLOBAL ;
--------------------------------------------------------
--  DDL for Table CREATE$JAVA$LOB$TABLE
--------------------------------------------------------

  CREATE TABLE "APP"."CREATE$JAVA$LOB$TABLE" 
   (	"NAME" VARCHAR2(700 BYTE), 
	"LOB" BLOB, 
	"LOADTIME" DATE
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" 
 LOB ("LOB") STORE AS SECUREFILE (
  TABLESPACE "USERS" ENABLE STORAGE IN ROW 4000 CHUNK 8192
  NOCACHE LOGGING  NOCOMPRESS  KEEP_DUPLICATES 
  STORAGE(INITIAL 262144 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)) ;
--------------------------------------------------------
--  DDL for Table CUSTOMER
--------------------------------------------------------

  CREATE TABLE "APP"."CUSTOMER" 
   (	"PHONE" VARCHAR2(20 BYTE), 
	"FULL_NAME" VARCHAR2(100 BYTE), 
	"PASSWORD_HASH" VARCHAR2(256 BYTE), 
	"PUBLIC_KEY" CLOB, 
	"CREATED_AT" TIMESTAMP (6) DEFAULT SYSTIMESTAMP, 
	"EMAIL" VARCHAR2(100 BYTE), 
	"ADDRESS" VARCHAR2(200 BYTE)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" 
 LOB ("PUBLIC_KEY") STORE AS SECUREFILE (
  TABLESPACE "USERS" ENABLE STORAGE IN ROW 4000 CHUNK 8192
  NOCACHE LOGGING  NOCOMPRESS  KEEP_DUPLICATES 
  STORAGE(INITIAL 262144 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)) ;
--------------------------------------------------------
--  DDL for Table CUSTOMER_APPOINTMENT
--------------------------------------------------------

  CREATE TABLE "APP"."CUSTOMER_APPOINTMENT" 
   (	"APPOINTMENT_ID" NUMBER, 
	"CUSTOMER_PHONE" VARCHAR2(20 BYTE), 
	"APPOINTMENT_DATE" DATE, 
	"STATUS" VARCHAR2(20 BYTE) DEFAULT 'SCHEDULED', 
	"DESCRIPTION" VARCHAR2(500 BYTE)
   ) SEGMENT CREATION DEFERRED 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Table EMPLOYEE
--------------------------------------------------------

  CREATE TABLE "APP"."EMPLOYEE" 
   (	"EMP_ID" NUMBER GENERATED BY DEFAULT AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE , 
	"FULL_NAME" VARCHAR2(100 BYTE), 
	"USERNAME" VARCHAR2(50 BYTE), 
	"PASSWORD_HASH" VARCHAR2(256 BYTE), 
	"PUBLIC_KEY" CLOB, 
	"CREATED_AT" TIMESTAMP (6) DEFAULT SYSTIMESTAMP, 
	"EMAIL" VARCHAR2(100 BYTE), 
	"PHONE" VARCHAR2(20 BYTE)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" 
 LOB ("PUBLIC_KEY") STORE AS SECUREFILE (
  TABLESPACE "USERS" ENABLE STORAGE IN ROW 4000 CHUNK 8192
  NOCACHE LOGGING  NOCOMPRESS  KEEP_DUPLICATES 
  STORAGE(INITIAL 262144 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)) ;
--------------------------------------------------------
--  DDL for Table EMPLOYEE_SHIFT
--------------------------------------------------------

  CREATE TABLE "APP"."EMPLOYEE_SHIFT" 
   (	"SHIFT_ID" NUMBER, 
	"EMP_ID" NUMBER, 
	"SHIFT_DATE" DATE, 
	"START_TIME" TIMESTAMP (6), 
	"END_TIME" TIMESTAMP (6), 
	"STATUS" VARCHAR2(20 BYTE) DEFAULT 'SCHEDULED'
   ) SEGMENT CREATION DEFERRED 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Table INVOICE
--------------------------------------------------------

  CREATE TABLE "APP"."INVOICE" 
   (	"INVOICE_ID" NUMBER, 
	"STOCKOUT_ID" NUMBER, 
	"CUSTOMER_PHONE" VARCHAR2(20 BYTE), 
	"EMP_ID" NUMBER, 
	"INVOICE_DATE" DATE DEFAULT SYSDATE, 
	"TOTAL_AMOUNT" NUMBER(20,2) DEFAULT 0, 
	"STATUS" VARCHAR2(20 BYTE) DEFAULT 'PENDING'
   ) SEGMENT CREATION DEFERRED 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Table INVOICE_ITEM
--------------------------------------------------------

  CREATE TABLE "APP"."INVOICE_ITEM" 
   (	"INVOICE_ID" NUMBER, 
	"STOCKOUT_ID" NUMBER, 
	"PART_ID" NUMBER, 
	"PRICE" NUMBER(20,2)
   ) SEGMENT CREATION DEFERRED 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Table INVOICE_SERVICE
--------------------------------------------------------

  CREATE TABLE "APP"."INVOICE_SERVICE" 
   (	"INVOICE_ID" NUMBER, 
	"SERVICE_ID" NUMBER, 
	"QUANTITY" NUMBER DEFAULT 1, 
	"PRICE" NUMBER(20,2)
   ) SEGMENT CREATION DEFERRED 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Table ORDERS
--------------------------------------------------------

  CREATE TABLE "APP"."ORDERS" 
   (	"ORDER_ID" NUMBER, 
	"CUSTOMER_PHONE" VARCHAR2(20 BYTE), 
	"RECEIVER_EMP" NUMBER, 
	"HANDLER_EMP" NUMBER, 
	"ORDER_TYPE" VARCHAR2(20 BYTE), 
	"RECEIVED_DATE" DATE, 
	"STATUS" VARCHAR2(50 BYTE), 
	"DESCRIPTION" VARCHAR2(500 BYTE)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Table ORDER_SERVICE
--------------------------------------------------------

  CREATE TABLE "APP"."ORDER_SERVICE" 
   (	"ORDER_ID" NUMBER, 
	"SERVICE_ID" NUMBER, 
	"QUANTITY" NUMBER DEFAULT 1, 
	"PRICE" NUMBER(20,2)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Table PART
--------------------------------------------------------

  CREATE TABLE "APP"."PART" 
   (	"PART_ID" NUMBER, 
	"NAME" VARCHAR2(100 BYTE), 
	"MANUFACTURER" VARCHAR2(100 BYTE), 
	"SERIAL" VARCHAR2(50 BYTE), 
	"STATUS" VARCHAR2(50 BYTE), 
	"STOCK_IN_ID" NUMBER, 
	"ORDER_ID" NUMBER, 
	"PRICE" NUMBER(20,2)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Table PART_REQUEST
--------------------------------------------------------

  CREATE TABLE "APP"."PART_REQUEST" 
   (	"REQUEST_ID" NUMBER, 
	"ORDER_ID" NUMBER, 
	"EMP_ID" NUMBER, 
	"REQUEST_DATE" DATE, 
	"STATUS" VARCHAR2(50 BYTE)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Table PART_REQUEST_ITEM
--------------------------------------------------------

  CREATE TABLE "APP"."PART_REQUEST_ITEM" 
   (	"REQUEST_ID" NUMBER, 
	"PART_ID" NUMBER
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Table SERVICE
--------------------------------------------------------

  CREATE TABLE "APP"."SERVICE" 
   (	"SERVICE_ID" NUMBER GENERATED BY DEFAULT AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE , 
	"NAME" VARCHAR2(100 BYTE), 
	"DESCRIPTION" VARCHAR2(500 BYTE), 
	"PRICE" NUMBER(20,2)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Table STOCK_IN
--------------------------------------------------------

  CREATE TABLE "APP"."STOCK_IN" 
   (	"STOCKIN_ID" NUMBER, 
	"EMP_ID" NUMBER, 
	"IN_DATE" DATE, 
	"NOTE" VARCHAR2(200 BYTE), 
	"SIGNATURE" VARCHAR2(4000 BYTE)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Table STOCK_IN_ITEM
--------------------------------------------------------

  CREATE TABLE "APP"."STOCK_IN_ITEM" 
   (	"STOCKIN_ITEM_ID" NUMBER, 
	"STOCKIN_ID" NUMBER, 
	"PART_NAME" VARCHAR2(100 BYTE), 
	"MANUFACTURER" VARCHAR2(100 BYTE), 
	"SERIAL" VARCHAR2(50 BYTE), 
	"PRICE" NUMBER(20,2)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Table STOCK_OUT
--------------------------------------------------------

  CREATE TABLE "APP"."STOCK_OUT" 
   (	"STOCKOUT_ID" NUMBER, 
	"ORDER_ID" NUMBER, 
	"EMP_ID" NUMBER, 
	"OUT_DATE" DATE, 
	"NOTE" VARCHAR2(200 BYTE), 
	"SIGNATURE" VARCHAR2(4000 BYTE)
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Table STOCK_OUT_ITEM
--------------------------------------------------------

  CREATE TABLE "APP"."STOCK_OUT_ITEM" 
   (	"STOCKOUT_ID" NUMBER, 
	"PART_ID" NUMBER
   ) SEGMENT CREATION IMMEDIATE 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Table USER_OTP_LOG
--------------------------------------------------------

  CREATE TABLE "APP"."USER_OTP_LOG" 
   (	"ID" NUMBER GENERATED BY DEFAULT AS IDENTITY MINVALUE 1 MAXVALUE 9999999999999999999999999999 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE  NOKEEP  NOSCALE , 
	"USER_ID" NUMBER, 
	"USERNAME" VARCHAR2(100 BYTE), 
	"OTP" VARCHAR2(10 BYTE), 
	"CREATED_AT" TIMESTAMP (6) DEFAULT SYSTIMESTAMP, 
	"EXPIRED_AT" TIMESTAMP (6), 
	"USED" CHAR(1 BYTE) DEFAULT 'N'
   ) SEGMENT CREATION DEFERRED 
  PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 
 NOCOMPRESS LOGGING
  TABLESPACE "USERS" ;
REM INSERTING into APP.CREATE$JAVA$LOB$TABLE
SET DEFINE OFF;
REM INSERTING into APP.CUSTOMER
SET DEFINE OFF;
Insert into APP.CUSTOMER (PHONE,FULL_NAME,PASSWORD_HASH,CREATED_AT,EMAIL,ADDRESS) values ('1','Dinh','6B86B273FF34FCE19D6B804EFF5A3F5747ADA4EAA22F1D49C01E52DDB7875B4B',to_timestamp('10-NOV-25 02.40.30.356827000 AM','DD-MON-RR HH.MI.SSXFF AM'),'Dinh@gmail.com','123a');
Insert into APP.CUSTOMER (PHONE,FULL_NAME,PASSWORD_HASH,CREATED_AT,EMAIL,ADDRESS) values ('0332880207','Khách hàng 1','6B86B273FF34FCE19D6B804EFF5A3F5747ADA4EAA22F1D49C01E52DDB7875B4B',to_timestamp('05-NOV-25 02.54.40.167598000 AM','DD-MON-RR HH.MI.SSXFF AM'),'KHACHHANG1@gmail.com','Khách hàng 1');
REM INSERTING into APP.CUSTOMER_APPOINTMENT
SET DEFINE OFF;
REM INSERTING into APP.EMPLOYEE
SET DEFINE OFF;
Insert into APP.EMPLOYEE (EMP_ID,FULL_NAME,USERNAME,PASSWORD_HASH,CREATED_AT,EMAIL,PHONE) values (4,'Tiếp tân','Tieptan','6B86B273FF34FCE19D6B804EFF5A3F5747ADA4EAA22F1D49C01E52DDB7875B4B',to_timestamp('05-NOV-25 03.27.17.488245000 AM','DD-MON-RR HH.MI.SSXFF AM'),'Tieptan@gmail.com','123456789');
Insert into APP.EMPLOYEE (EMP_ID,FULL_NAME,USERNAME,PASSWORD_HASH,CREATED_AT,EMAIL,PHONE) values (1,'Admin','Admin','C1C224B03CD9BC7B6A86D77F5DACE40191766C485CD55DC48CAF9AC873335D6F',to_timestamp('05-NOV-25 02.59.17.776616000 AM','DD-MON-RR HH.MI.SSXFF AM'),'Admin@example.com','0987654321');
Insert into APP.EMPLOYEE (EMP_ID,FULL_NAME,USERNAME,PASSWORD_HASH,CREATED_AT,EMAIL,PHONE) values (3,'Kĩ Thuật Viên','Kithuatvien','6B86B273FF34FCE19D6B804EFF5A3F5747ADA4EAA22F1D49C01E52DDB7875B4B',to_timestamp('05-NOV-25 03.16.09.522782000 AM','DD-MON-RR HH.MI.SSXFF AM'),'Kithuatvien@gmail.com','123476898');
Insert into APP.EMPLOYEE (EMP_ID,FULL_NAME,USERNAME,PASSWORD_HASH,CREATED_AT,EMAIL,PHONE) values (2,'THUKHO','Thukho','6B86B273FF34FCE19D6B804EFF5A3F5747ADA4EAA22F1D49C01E52DDB7875B4B',to_timestamp('05-NOV-25 03.10.26.090963000 AM','DD-MON-RR HH.MI.SSXFF AM'),'Thukho@gmail.com','03332917468');
REM INSERTING into APP.EMPLOYEE_SHIFT
SET DEFINE OFF;
REM INSERTING into APP.INVOICE
SET DEFINE OFF;
REM INSERTING into APP.INVOICE_ITEM
SET DEFINE OFF;
REM INSERTING into APP.INVOICE_SERVICE
SET DEFINE OFF;
REM INSERTING into APP.ORDERS
SET DEFINE OFF;
Insert into APP.ORDERS (ORDER_ID,CUSTOMER_PHONE,RECEIVER_EMP,HANDLER_EMP,ORDER_TYPE,RECEIVED_DATE,STATUS,DESCRIPTION) values (83,'1',1,3,'REPAIR',to_date('10-NOV-25','DD-MON-RR'),'Đã tiếp nhận','ABC');
Insert into APP.ORDERS (ORDER_ID,CUSTOMER_PHONE,RECEIVER_EMP,HANDLER_EMP,ORDER_TYPE,RECEIVED_DATE,STATUS,DESCRIPTION) values (84,'0332880207',1,3,'REPAIR',to_date('10-NOV-25','DD-MON-RR'),'Đã tiếp nhận','Test dịch vụ');
Insert into APP.ORDERS (ORDER_ID,CUSTOMER_PHONE,RECEIVER_EMP,HANDLER_EMP,ORDER_TYPE,RECEIVED_DATE,STATUS,DESCRIPTION) values (85,'0332880207',1,3,'WARRANTY',to_date('10-NOV-25','DD-MON-RR'),'COMPLETED','Bảo hành điện thoại');
REM INSERTING into APP.ORDER_SERVICE
SET DEFINE OFF;
Insert into APP.ORDER_SERVICE (ORDER_ID,SERVICE_ID,QUANTITY,PRICE) values (85,3,1,0);
REM INSERTING into APP.PART
SET DEFINE OFF;
Insert into APP.PART (PART_ID,NAME,MANUFACTURER,SERIAL,STATUS,STOCK_IN_ID,ORDER_ID,PRICE) values (302,'Mặt kính lưng IP XS','Apple','MKLXS-1','IN_STOCK',36,null,10000);
Insert into APP.PART (PART_ID,NAME,MANUFACTURER,SERIAL,STATUS,STOCK_IN_ID,ORDER_ID,PRICE) values (303,'Mặt kính lưng IP XS','Apple','MKLXS-2','EXPORTED',36,85,10000);
Insert into APP.PART (PART_ID,NAME,MANUFACTURER,SERIAL,STATUS,STOCK_IN_ID,ORDER_ID,PRICE) values (304,'Mặt kính lưng IP XS','Apple','MKLXS-3','IN_STOCK',36,null,10000);
Insert into APP.PART (PART_ID,NAME,MANUFACTURER,SERIAL,STATUS,STOCK_IN_ID,ORDER_ID,PRICE) values (305,'Mặt kính lưng IP XS','Apple','MKLXS-4','IN_STOCK',36,null,10000);
Insert into APP.PART (PART_ID,NAME,MANUFACTURER,SERIAL,STATUS,STOCK_IN_ID,ORDER_ID,PRICE) values (306,'Mặt kính lưng IP XS','Apple','MKLXS-5','IN_STOCK',36,null,10000);
Insert into APP.PART (PART_ID,NAME,MANUFACTURER,SERIAL,STATUS,STOCK_IN_ID,ORDER_ID,PRICE) values (307,'Mặt kính lưng IP XS','Apple','MKLXS-6','IN_STOCK',36,null,10000);
Insert into APP.PART (PART_ID,NAME,MANUFACTURER,SERIAL,STATUS,STOCK_IN_ID,ORDER_ID,PRICE) values (308,'Mặt kính lưng IP XS','Apple','MKLXS-7','IN_STOCK',36,null,10000);
Insert into APP.PART (PART_ID,NAME,MANUFACTURER,SERIAL,STATUS,STOCK_IN_ID,ORDER_ID,PRICE) values (309,'Mặt kính lưng IP XS','Apple','MKLXS-8','IN_STOCK',36,null,10000);
Insert into APP.PART (PART_ID,NAME,MANUFACTURER,SERIAL,STATUS,STOCK_IN_ID,ORDER_ID,PRICE) values (310,'Mặt kính lưng IP XS','Apple','MKLXS-9','IN_STOCK',36,null,10000);
Insert into APP.PART (PART_ID,NAME,MANUFACTURER,SERIAL,STATUS,STOCK_IN_ID,ORDER_ID,PRICE) values (311,'Mặt kính lưng IP XS','Apple','MKLXS-10','IN_STOCK',36,null,10000);
REM INSERTING into APP.PART_REQUEST
SET DEFINE OFF;
Insert into APP.PART_REQUEST (REQUEST_ID,ORDER_ID,EMP_ID,REQUEST_DATE,STATUS) values (26,84,1,to_date('10-NOV-25','DD-MON-RR'),'ACCEPT');
REM INSERTING into APP.PART_REQUEST_ITEM
SET DEFINE OFF;
Insert into APP.PART_REQUEST_ITEM (REQUEST_ID,PART_ID) values (26,303);
REM INSERTING into APP.SERVICE
SET DEFINE OFF;
Insert into APP.SERVICE (SERVICE_ID,NAME,DESCRIPTION,PRICE) values (1,'Dịch vụ Vệ sinh thiết bị','Vệ sinh toàn diện bên trong và ngoài thiết bị, tối ưu hóa phần mềm cơ bản.',100000);
Insert into APP.SERVICE (SERVICE_ID,NAME,DESCRIPTION,PRICE) values (2,'Dịch vụ Sửa chữa tổng quát','Phí công thợ sửa chữa cho các lỗi phần cứng và phần mềm, chưa bao gồm linh kiện thay thế.',350000);
Insert into APP.SERVICE (SERVICE_ID,NAME,DESCRIPTION,PRICE) values (3,'Dịch vụ Bảo hành','Dịch vụ Bảo hành',0);
REM INSERTING into APP.STOCK_IN
SET DEFINE OFF;
Insert into APP.STOCK_IN (STOCKIN_ID,EMP_ID,IN_DATE,NOTE,SIGNATURE) values (36,1,to_date('10-NOV-25','DD-MON-RR'),'Lô đầu tiên','Zv8DvscPXTvYlNfzVZh1FeuqOmrwIOAiR8YQiqRylp9dAbQka5nQPaQr8Kkdw00UH48JlULVYbAUWGULh68ddS7xxeT1z08Navr7q6ToYf8sGFD39zgdAMxauK5S6isHhqfF0VPr9Q9qDXNFp2lVhiRrUpOfZWZIbNNenkHEynw=');
REM INSERTING into APP.STOCK_IN_ITEM
SET DEFINE OFF;
Insert into APP.STOCK_IN_ITEM (STOCKIN_ITEM_ID,STOCKIN_ID,PART_NAME,MANUFACTURER,SERIAL,PRICE) values (305,36,'Mặt kính lưng IP XS','Apple','MKLXS-1',10000);
Insert into APP.STOCK_IN_ITEM (STOCKIN_ITEM_ID,STOCKIN_ID,PART_NAME,MANUFACTURER,SERIAL,PRICE) values (306,36,'Mặt kính lưng IP XS','Apple','MKLXS-2',10000);
Insert into APP.STOCK_IN_ITEM (STOCKIN_ITEM_ID,STOCKIN_ID,PART_NAME,MANUFACTURER,SERIAL,PRICE) values (307,36,'Mặt kính lưng IP XS','Apple','MKLXS-3',10000);
Insert into APP.STOCK_IN_ITEM (STOCKIN_ITEM_ID,STOCKIN_ID,PART_NAME,MANUFACTURER,SERIAL,PRICE) values (308,36,'Mặt kính lưng IP XS','Apple','MKLXS-4',10000);
Insert into APP.STOCK_IN_ITEM (STOCKIN_ITEM_ID,STOCKIN_ID,PART_NAME,MANUFACTURER,SERIAL,PRICE) values (309,36,'Mặt kính lưng IP XS','Apple','MKLXS-5',10000);
Insert into APP.STOCK_IN_ITEM (STOCKIN_ITEM_ID,STOCKIN_ID,PART_NAME,MANUFACTURER,SERIAL,PRICE) values (310,36,'Mặt kính lưng IP XS','Apple','MKLXS-6',10000);
Insert into APP.STOCK_IN_ITEM (STOCKIN_ITEM_ID,STOCKIN_ID,PART_NAME,MANUFACTURER,SERIAL,PRICE) values (311,36,'Mặt kính lưng IP XS','Apple','MKLXS-7',10000);
Insert into APP.STOCK_IN_ITEM (STOCKIN_ITEM_ID,STOCKIN_ID,PART_NAME,MANUFACTURER,SERIAL,PRICE) values (312,36,'Mặt kính lưng IP XS','Apple','MKLXS-8',10000);
Insert into APP.STOCK_IN_ITEM (STOCKIN_ITEM_ID,STOCKIN_ID,PART_NAME,MANUFACTURER,SERIAL,PRICE) values (313,36,'Mặt kính lưng IP XS','Apple','MKLXS-9',10000);
Insert into APP.STOCK_IN_ITEM (STOCKIN_ITEM_ID,STOCKIN_ID,PART_NAME,MANUFACTURER,SERIAL,PRICE) values (314,36,'Mặt kính lưng IP XS','Apple','MKLXS-10',10000);
REM INSERTING into APP.STOCK_OUT
SET DEFINE OFF;
Insert into APP.STOCK_OUT (STOCKOUT_ID,ORDER_ID,EMP_ID,OUT_DATE,NOTE,SIGNATURE) values (2,85,1,to_date('10-NOV-25','DD-MON-RR'),'Xuất kho tự động cho Order ID 85','K5bH1qaJCajnD20WwKOUSYVXPvHLOVspISQ30sGXmyPP9hruBeDYqBfIZu96+aQLV+leguh7wpOn2/1Lv4bltng5kNHZYW+MhZiWtuoY24Q1FCvMzWg0z0hLon9Tiv7Mz2DfcDlZC6DPJK7Ml2CkOyVY/1nseZyyAEpL0jGk0cw=');
REM INSERTING into APP.STOCK_OUT_ITEM
SET DEFINE OFF;
Insert into APP.STOCK_OUT_ITEM (STOCKOUT_ID,PART_ID) values (2,303);
REM INSERTING into APP.USER_OTP_LOG
SET DEFINE OFF;
--------------------------------------------------------
--  DDL for Index PK_INVOICEITEM
--------------------------------------------------------

  CREATE UNIQUE INDEX "APP"."PK_INVOICEITEM" ON "APP"."INVOICE_ITEM" ("INVOICE_ID", "STOCKOUT_ID", "PART_ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Index UK_INVOICEITEM_STOCKOUT_PART
--------------------------------------------------------

  CREATE UNIQUE INDEX "APP"."UK_INVOICEITEM_STOCKOUT_PART" ON "APP"."INVOICE_ITEM" ("STOCKOUT_ID", "PART_ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Index PK_PARTREQUESTITEM
--------------------------------------------------------

  CREATE UNIQUE INDEX "APP"."PK_PARTREQUESTITEM" ON "APP"."PART_REQUEST_ITEM" ("REQUEST_ID", "PART_ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Index PK_INVOICESERVICE
--------------------------------------------------------

  CREATE UNIQUE INDEX "APP"."PK_INVOICESERVICE" ON "APP"."INVOICE_SERVICE" ("INVOICE_ID", "SERVICE_ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Index PK_STOCKOUTITEM
--------------------------------------------------------

  CREATE UNIQUE INDEX "APP"."PK_STOCKOUTITEM" ON "APP"."STOCK_OUT_ITEM" ("STOCKOUT_ID", "PART_ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Index PK_ORDERSERVICE
--------------------------------------------------------

  CREATE UNIQUE INDEX "APP"."PK_ORDERSERVICE" ON "APP"."ORDER_SERVICE" ("ORDER_ID", "SERVICE_ID") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for Procedure ACCEPT_PART_REQUEST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."ACCEPT_PART_REQUEST" (
    p_request_id IN NUMBER
)
AS
BEGIN
    -- 1. Cập nhật trạng thái request
    UPDATE PART_REQUEST
    SET STATUS = 'Đồng ý'
    WHERE REQUEST_ID = p_request_id; 
    -- 2. Cập nhật tất cả part dựa trên request items
    UPDATE PART p
       SET STATUS = 'Đã gán',
           ORDER_ID = (SELECT pr.ORDER_ID
                       FROM PART_REQUEST pr
                      WHERE pr.REQUEST_ID = p_request_id)
     WHERE p.PART_ID IN (SELECT pri.PART_ID
                           FROM PART_REQUEST_ITEM pri
                          WHERE pri.REQUEST_ID = p_request_id);

    COMMIT;
END ACCEPT_PART_REQUEST;

/

  GRANT EXECUTE ON "APP"."ACCEPT_PART_REQUEST" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure ASSIGN_PROFILE_TO_USER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."ASSIGN_PROFILE_TO_USER" (
    p_username IN VARCHAR2,
    p_profile_name IN VARCHAR2
)
AS
BEGIN
    EXECUTE IMMEDIATE 'ALTER USER "' || p_username || '" PROFILE "' || UPPER(p_profile_name) || '"';
END ASSIGN_PROFILE_TO_USER;

/

  GRANT EXECUTE ON "APP"."ASSIGN_PROFILE_TO_USER" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure ASSIGN_ROLE_PROC
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."ASSIGN_ROLE_PROC" (
    p_username IN VARCHAR2,
    p_role_name IN VARCHAR2
)
AS
BEGIN
    EXECUTE IMMEDIATE 'GRANT "' || p_role_name || '" TO "' || p_username || '"';
END;

/

  GRANT EXECUTE ON "APP"."ASSIGN_ROLE_PROC" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure COMPLETE_PART_REQUEST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."COMPLETE_PART_REQUEST" (
    p_request_id IN NUMBER
)
AS
BEGIN
    -- 1. Cập nhật trạng thái request 
    UPDATE PART_REQUEST
    SET STATUS = 'Từ chối'
    WHERE REQUEST_ID = p_request_id;

    -- 2. Cập nhật tất cả part dựa trên request items
    UPDATE PART p
       SET STATUS = 'Đã gán',
           ORDER_ID = (SELECT pr.ORDER_ID
                       FROM PART_REQUEST pr
                      WHERE pr.REQUEST_ID = p_request_id)
     WHERE p.PART_ID IN (SELECT pri.PART_ID
                           FROM PART_REQUEST_ITEM pri
                          WHERE pri.REQUEST_ID = p_request_id);

    COMMIT;
END COMPLETE_PART_REQUEST;

/

  GRANT EXECUTE ON "APP"."COMPLETE_PART_REQUEST" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure CREATE_APPOINTMENT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."CREATE_APPOINTMENT" (
    p_customer_phone IN VARCHAR2,
    p_appointment_date IN DATE,
    p_description IN VARCHAR2 DEFAULT NULL,
    p_status OUT VARCHAR2
)
AS
BEGIN
    INSERT INTO CUSTOMER_APPOINTMENT (
        APPOINTMENT_ID,
        CUSTOMER_PHONE,
        APPOINTMENT_DATE,
        STATUS,
        DESCRIPTION
    )
    VALUES (
        APPOINTMENT_SEQ.NEXTVAL,  -- giả sử bạn có sequence APPOINTMENT_SEQ
        p_customer_phone,
        p_appointment_date,
        'Đã lên lịch',  -- mặc định trạng thái
        p_description
    );

    p_status := 'Đã lên lịch';

    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE_APPLICATION_ERROR(-20001, 'Không thể tạo lịch: ' || SQLERRM);
END;

/

  GRANT EXECUTE ON "APP"."CREATE_APPOINTMENT" TO "ROLE_KHACHHANG";
--------------------------------------------------------
--  DDL for Procedure CREATE_ORDER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."CREATE_ORDER" (
    p_customer_phone      IN VARCHAR2,
    p_receiver_emp_name   IN VARCHAR2,
    p_handler_emp_name    IN VARCHAR2,
    p_order_type          IN VARCHAR2,
    p_status              IN VARCHAR2,
    p_description         IN VARCHAR2 DEFAULT NULL,
    p_order_id            OUT NUMBER -- ✅ Thêm tham số OUT để trả về ID mới
)
AS
    v_receiver_emp_id EMPLOYEE.EMP_ID%TYPE;
    v_handler_emp_id  EMPLOYEE.EMP_ID%TYPE;
BEGIN
    -- 1. Lấy EMP_ID từ username (Giữ nguyên logic)
    SELECT EMP_ID INTO v_receiver_emp_id
      FROM EMPLOYEE
     WHERE USERNAME = p_receiver_emp_name;

    SELECT EMP_ID INTO v_handler_emp_id
      FROM EMPLOYEE
     WHERE USERNAME = p_handler_emp_name;

    -- 2. Insert đơn hàng và trả về ID
    INSERT INTO ORDERS (
        ORDER_ID,
        CUSTOMER_PHONE,
        RECEIVER_EMP,
        HANDLER_EMP,
        ORDER_TYPE,
        RECEIVED_DATE,
        STATUS,
        DESCRIPTION
    ) VALUES (
        -- Giả định ORDERS_SEQ là Sequence để tạo ORDER_ID
        ORDERS_SEQ.NEXTVAL,
        p_customer_phone,
        v_receiver_emp_id,
        v_handler_emp_id,
        p_order_type,
        SYSDATE,
        p_status,
        p_description
    )
    -- ✅ Thêm mệnh đề RETURNING INTO để gán ID mới cho tham số OUT
    RETURNING ORDER_ID INTO p_order_id; 

    -- ❌ Đã xóa lệnh COMMIT vì Transaction được quản lý ở tầng C#
    
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        -- Không cần ROLLBACK ở đây vì C# sẽ xử lý Transaction
        RAISE_APPLICATION_ERROR(-20001, 'Username nhân viên hoặc Khách hàng không tồn tại.');
    WHEN OTHERS THEN
        -- Không cần ROLLBACK
        RAISE;
END CREATE_ORDER;

/

  GRANT EXECUTE ON "APP"."CREATE_ORDER" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."CREATE_ORDER" TO "ROLE_TIEPTAN";
--------------------------------------------------------
--  DDL for Procedure CREATE_ORDER_SERVICE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."CREATE_ORDER_SERVICE" (
    p_order_id      IN ORDER_SERVICE.ORDER_ID%TYPE,
    p_service_id    IN ORDER_SERVICE.SERVICE_ID%TYPE,
    p_quantity      IN ORDER_SERVICE.QUANTITY%TYPE,
    p_price         IN ORDER_SERVICE.PRICE%TYPE,
    p_result        OUT VARCHAR2 -- Tham số OUT để trả về kết quả
)
AS
    v_count NUMBER;
BEGIN
    -- 1. Kiểm tra tính hợp lệ của ORDER_ID và SERVICE_ID

    -- Kiểm tra Order có tồn tại không
    SELECT COUNT(*) INTO v_count FROM ORDERS WHERE ORDER_ID = p_order_id;
    IF v_count = 0 THEN
        p_result := 'Lỗi: Order ID ' || p_order_id || ' không tồn tại.';
        RETURN;
    END IF;

    -- Kiểm tra Service có tồn tại không
    SELECT COUNT(*) INTO v_count FROM SERVICE WHERE SERVICE_ID = p_service_id;
    IF v_count = 0 THEN
        p_result := 'Lỗi: Service ID ' || p_service_id || ' không tồn tại.';
        RETURN;
    END IF;

    -- Kiểm tra xem dịch vụ này đã được thêm vào order này chưa (dựa vào PK)
    SELECT COUNT(*) INTO v_count 
    FROM ORDER_SERVICE 
    WHERE ORDER_ID = p_order_id AND SERVICE_ID = p_service_id;

    IF v_count > 0 THEN
        p_result := 'Lỗi: Dịch vụ này đã tồn tại trong Order ID ' || p_order_id || '.';
        RETURN;
    END IF;

    -- 2. Chèn dữ liệu mới vào ORDER_SERVICE
    INSERT INTO ORDER_SERVICE (
        ORDER_ID, 
        SERVICE_ID, 
        QUANTITY, 
        PRICE
    ) VALUES (
        p_order_id, 
        p_service_id, 
        p_quantity, 
        p_price
    );

    -- Ghi nhận thành công
    p_result := 'Thành công: Đã thêm dịch vụ ' || p_service_id || ' vào Order ' || p_order_id || '.';

    COMMIT;

EXCEPTION
    WHEN OTHERS THEN
        -- Xử lý lỗi hệ thống chung
        ROLLBACK;
        p_result := 'Lỗi hệ thống: ' || SQLERRM;
END;

/

  GRANT EXECUTE ON "APP"."CREATE_ORDER_SERVICE" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."CREATE_ORDER_SERVICE" TO "ROLE_TIEPTAN";
--------------------------------------------------------
--  DDL for Procedure CREATE_PART
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."CREATE_PART" (
    p_stockin_id IN NUMBER,
    p_part_name IN VARCHAR2,
    p_manufacturer IN VARCHAR2,
    p_serial IN VARCHAR2,
    p_price IN NUMBER       -- thêm tham số price
)
AS
BEGIN
    INSERT INTO APP.PART (
        PART_ID, NAME, MANUFACTURER, SERIAL, STATUS, STOCK_IN_ID, PRICE
    )
    VALUES (
        PART_SEQ.NEXTVAL, p_part_name, p_manufacturer, p_serial, 'Trong kho', p_stockin_id, p_price
    );
END CREATE_PART;

/

  GRANT EXECUTE ON "APP"."CREATE_PART" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."CREATE_PART" TO "ROLE_THUKHO";
--------------------------------------------------------
--  DDL for Procedure CREATE_PART_REQUEST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."CREATE_PART_REQUEST" (
    p_order_id     IN NUMBER,
    p_emp_id       IN NUMBER,
    p_status       IN VARCHAR2,
    p_request_date IN DATE,       -- nhận từ C#
    p_request_id   OUT NUMBER
)
AS
BEGIN
    INSERT INTO PART_REQUEST (REQUEST_ID, ORDER_ID, EMP_ID, REQUEST_DATE, STATUS)
    VALUES (PART_REQUEST_SEQ.NEXTVAL, p_order_id, p_emp_id, p_request_date, p_status)
    RETURNING REQUEST_ID INTO p_request_id;
END;

/

  GRANT EXECUTE ON "APP"."CREATE_PART_REQUEST" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure CREATE_PART_REQUEST_ITEM
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."CREATE_PART_REQUEST_ITEM" (
    p_request_id IN NUMBER,
    p_part_id    IN NUMBER
    -- Không cần tham số OUT vì không có ID tự động tăng để trả về
)
AS
    -- Khai báo biến để kiểm tra sự tồn tại (Tùy chọn, Khóa Chính sẽ tự kiểm tra)
    v_count NUMBER; 
BEGIN
    -- 1. (Tùy chọn) Kiểm tra xem linh kiện đã được yêu cầu chưa
    SELECT COUNT(*) INTO v_count 
    FROM PART_REQUEST_ITEM 
    WHERE REQUEST_ID = p_request_id AND PART_ID = p_part_id;
    
    IF v_count > 0 THEN
        -- Nếu đã tồn tại, có thể RAISE lỗi hoặc đơn giản là thoát
        RAISE_APPLICATION_ERROR(-20001, 
            'Lỗi: Linh kiện ' || p_part_id || ' đã tồn tại trong yêu cầu ' || p_request_id || '.');
    END IF;

    -- 2. Chèn dữ liệu mới
    INSERT INTO PART_REQUEST_ITEM (REQUEST_ID, PART_ID)
    VALUES (p_request_id, p_part_id);
    
    -- Thêm logic nghiệp vụ: Cập nhật trạng thái của linh kiện (PART.STATUS) thành 'REQUESTED'
    UPDATE PART
    SET STATUS = 'Đã được đăng kí'
    WHERE PART_ID = p_part_id;
    
    COMMIT;
    
EXCEPTION
    -- Xử lý lỗi nếu Khóa Ngoại (FK) bị vi phạm (Request hoặc Part không tồn tại)
    WHEN OTHERS THEN
        ROLLBACK;
        -- Lỗi ORA-00001 (Unique constraint violated) sẽ tự động được xử lý nếu bạn bỏ qua bước kiểm tra v_count
        RAISE_APPLICATION_ERROR(-20002, 'Lỗi hệ thống khi tạo yêu cầu linh kiện: ' || SQLERRM);
END;

/

  GRANT EXECUTE ON "APP"."CREATE_PART_REQUEST_ITEM" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure CREATE_PROFILE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."CREATE_PROFILE" (
    p_profile_name IN VARCHAR2,
    p_failed_login IN VARCHAR2 DEFAULT 'UNLIMITED',
    p_life_time IN VARCHAR2 DEFAULT 'UNLIMITED',
    p_grace_time IN VARCHAR2 DEFAULT 'UNLIMITED',
    p_lock_time IN VARCHAR2 DEFAULT 'UNLIMITED'
)
AS
BEGIN
    EXECUTE IMMEDIATE 'CREATE PROFILE ' || UPPER(p_profile_name) || ' LIMIT
        FAILED_LOGIN_ATTEMPTS ' || p_failed_login || '
        PASSWORD_LIFE_TIME ' || p_life_time || '
        PASSWORD_GRACE_TIME ' || p_grace_time || '
        PASSWORD_LOCK_TIME ' || p_lock_time;
END CREATE_PROFILE;

/

  GRANT EXECUTE ON "APP"."CREATE_PROFILE" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure CREATE_ROLE_PROC
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."CREATE_ROLE_PROC" (p_role_name IN VARCHAR2)
AS
BEGIN
    EXECUTE IMMEDIATE 'CREATE ROLE "' || p_role_name || '"';
END;

/

  GRANT EXECUTE ON "APP"."CREATE_ROLE_PROC" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure CREATE_STOCKIN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."CREATE_STOCKIN" (
    p_emp_id IN NUMBER,
    p_note IN VARCHAR2,
    p_signature IN VARCHAR2,
    p_stockin_id OUT NUMBER
)
AS
BEGIN
    INSERT INTO APP.STOCK_IN (STOCKIN_ID, EMP_ID, IN_DATE, NOTE, SIGNATURE)
    VALUES (STOCKIN_SEQ.NEXTVAL, p_emp_id, SYSDATE, p_note, p_signature)
    RETURNING STOCKIN_ID INTO p_stockin_id;
END CREATE_STOCKIN;

/

  GRANT EXECUTE ON "APP"."CREATE_STOCKIN" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."CREATE_STOCKIN" TO "ROLE_THUKHO";
--------------------------------------------------------
--  DDL for Procedure CREATE_STOCKIN_ITEM
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."CREATE_STOCKIN_ITEM" (
    p_stockin_id IN NUMBER,
    p_part_name IN VARCHAR2,
    p_manufacturer IN VARCHAR2,
    p_serial IN VARCHAR2,
    p_price IN NUMBER,             -- thêm tham số price
    p_stockin_item_id OUT NUMBER
)
AS
BEGIN
    INSERT INTO APP.STOCK_IN_ITEM (
        STOCKIN_ITEM_ID, STOCKIN_ID, PART_NAME, MANUFACTURER, SERIAL, PRICE
    )
    VALUES (
        STOCKIN_ITEM_SEQ.NEXTVAL, p_stockin_id, p_part_name, p_manufacturer, p_serial, p_price
    )
    RETURNING STOCKIN_ITEM_ID INTO p_stockin_item_id;
END CREATE_STOCKIN_ITEM;

/

  GRANT EXECUTE ON "APP"."CREATE_STOCKIN_ITEM" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."CREATE_STOCKIN_ITEM" TO "ROLE_THUKHO";
--------------------------------------------------------
--  DDL for Procedure CREATE_STOCKOUT_TRANSACTION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."CREATE_STOCKOUT_TRANSACTION" (
    p_order_id     IN NUMBER,
    p_emp_id       IN NUMBER,
    p_note         IN VARCHAR2,
    p_signature    IN VARCHAR2,
    p_stockout_id  OUT NUMBER
)
AS
    l_part_count NUMBER := 0;
BEGIN
    -- 1. KIỂM TRA ĐƠN HÀNG VÀ SỐ LƯỢNG LINH KIỆN
    -- Kiểm tra Order có tồn tại không
    SELECT COUNT(*) INTO l_part_count
    FROM APP.ORDERS o
    WHERE o.ORDER_ID = p_order_id;

    IF l_part_count = 0 THEN
        RAISE_APPLICATION_ERROR(-20002, 'Lỗi: Order ID ' || p_order_id || ' không tồn tại.');
    END IF;

    -- Đếm số lượng linh kiện (PART) đã gán cho Order này
    SELECT COUNT(*) INTO l_part_count
    FROM APP.PART p
    WHERE p.ORDER_ID = p_order_id
      AND p.STATUS IN ('Đã gán'); 

    IF l_part_count = 0 THEN
        RAISE_APPLICATION_ERROR(-20003, 'Lỗi: Không có linh kiện nào sẵn sàng để xuất kho cho Order ID ' || p_order_id);
    END IF;

    -- 2. TẠO PHIẾU XUẤT KHO (STOCK_OUT)
    INSERT INTO APP.STOCK_OUT (STOCKOUT_ID, ORDER_ID, EMP_ID, OUT_DATE, NOTE, SIGNATURE)
    VALUES (STOCKOUT_SEQ.NEXTVAL, p_order_id, p_emp_id, SYSDATE, p_note, p_signature)
    RETURNING STOCKOUT_ID INTO p_stockout_id;

    -- 3. CHÈN BẢN GHI VÀO STOCK_OUT_ITEM VÀ CẬP NHẬT PART

    -- Chèn tất cả PART_ID có cùng ORDER_ID vào STOCK_OUT_ITEM
    INSERT INTO APP.STOCK_OUT_ITEM (STOCKOUT_ID, PART_ID)
    SELECT 
        p_stockout_id, 
        p.PART_ID
    FROM 
        APP.PART p
    WHERE 
        p.ORDER_ID = p_order_id
        AND p.STATUS IN ('Đã gán');

    -- Cập nhật trạng thái và Order_ID cho các linh kiện đã được xuất
    UPDATE APP.PART
    SET 
        STATUS = 'Đã xuất kho' -- Đánh dấu đã sử dụng
    WHERE 
        ORDER_ID = p_order_id
        AND STATUS IN ('Đã gán');

    -- 4. CẬP NHẬT TRẠNG THÁI ORDER (Tùy chọn: Đánh dấu Order đã được xuất kho)
     UPDATE APP.ORDERS
     SET STATUS = 'Đã hoàn thành' 
     WHERE ORDER_ID = p_order_id;

    COMMIT; -- Tự động commit sau khi thành công

EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END CREATE_STOCKOUT_TRANSACTION;

/
--------------------------------------------------------
--  DDL for Procedure DELETE_PROFILE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."DELETE_PROFILE" (
    p_profile_name IN VARCHAR2
)
AS
BEGIN
    EXECUTE IMMEDIATE 'DROP PROFILE ' || UPPER(p_profile_name) || ' CASCADE';
END DELETE_PROFILE;

/

  GRANT EXECUTE ON "APP"."DELETE_PROFILE" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure DELETE_ROLE_PROC
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."DELETE_ROLE_PROC" (p_role_name IN VARCHAR2)
AS
BEGIN
    EXECUTE IMMEDIATE 'DROP ROLE "' || p_role_name || '"';
END;

/

  GRANT EXECUTE ON "APP"."DELETE_ROLE_PROC" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure DENY_PART_REQUEST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."DENY_PART_REQUEST" (
    p_request_id IN NUMBER
)
AS
BEGIN
    -- 1. Cập nhật trạng thái request
    UPDATE PART_REQUEST
    SET STATUS = 'Từ chối'
    WHERE REQUEST_ID = p_request_id;



    COMMIT;
END DENY_PART_REQUEST;

/

  GRANT EXECUTE ON "APP"."DENY_PART_REQUEST" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure GET_ALL_APPOINTMENTS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_ALL_APPOINTMENTS" (
    p_cursor OUT SYS_REFCURSOR
)
AS
BEGIN
    OPEN p_cursor FOR
        SELECT APPOINTMENT_ID,
               CUSTOMER_PHONE,
               APPOINTMENT_DATE,
               STATUS,
               DESCRIPTION
        FROM CUSTOMER_APPOINTMENT
        ORDER BY APPOINTMENT_DATE DESC;
END;

/

  GRANT EXECUTE ON "APP"."GET_ALL_APPOINTMENTS" TO "ROLE_KHACHHANG";
  GRANT EXECUTE ON "APP"."GET_ALL_APPOINTMENTS" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."GET_ALL_APPOINTMENTS" TO "ROLE_TIEPTAN";
--------------------------------------------------------
--  DDL for Procedure GET_ALL_CUSTOMERS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_ALL_CUSTOMERS" (
    p_cursor OUT SYS_REFCURSOR
)
AS
BEGIN
    OPEN p_cursor FOR
        SELECT c.PHONE,
               c.FULL_NAME,
               c.EMAIL,
               -- Lấy trạng thái từ DBA_USERS
               (SELECT ACCOUNT_STATUS 
                FROM DBA_USERS d 
                WHERE d.USERNAME = UPPER(c.PHONE)) AS STATUS,
               -- Lấy role gộp thành 1 chuỗi
               (SELECT LISTAGG(GRANTED_ROLE, ', ') WITHIN GROUP (ORDER BY GRANTED_ROLE)
                FROM DBA_ROLE_PRIVS r
                WHERE r.GRANTEE = UPPER(c.PHONE)) AS ROLES
        FROM APP.CUSTOMER c;
END;

/

  GRANT EXECUTE ON "APP"."GET_ALL_CUSTOMERS" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."GET_ALL_CUSTOMERS" TO "ROLE_TIEPTAN";
  GRANT EXECUTE ON "APP"."GET_ALL_CUSTOMERS" TO "ROLE_THUKHO";
  GRANT EXECUTE ON "APP"."GET_ALL_CUSTOMERS" TO "ROLE_KITHUATVIEN";
  GRANT EXECUTE ON "APP"."GET_ALL_CUSTOMERS" TO "ROLE_KHACHHANG";
--------------------------------------------------------
--  DDL for Procedure GET_ALL_EMPLOYEES
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_ALL_EMPLOYEES" (
    p_cursor OUT SYS_REFCURSOR
)
AS
BEGIN
    OPEN p_cursor FOR
        SELECT e.EMP_ID,
               e.FULL_NAME,
               e.USERNAME,
               e.EMAIL,
               e.PHONE,
               -- Lấy trạng thái từ DBA_USERS
               (SELECT ACCOUNT_STATUS 
                FROM DBA_USERS d 
                WHERE d.USERNAME = UPPER(e.USERNAME)) AS STATUS,
               -- Lấy role gộp thành 1 chuỗi
               (SELECT LISTAGG(GRANTED_ROLE, ', ') WITHIN GROUP (ORDER BY GRANTED_ROLE)
                FROM DBA_ROLE_PRIVS r
                WHERE r.GRANTEE = UPPER(e.USERNAME)) AS ROLES
        FROM APP.EMPLOYEE e;
END;

/

  GRANT EXECUTE ON "APP"."GET_ALL_EMPLOYEES" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."GET_ALL_EMPLOYEES" TO "ROLE_TIEPTAN";
--------------------------------------------------------
--  DDL for Procedure GET_ALL_EXPORTS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_ALL_EXPORTS" (
    cur_out OUT SYS_REFCURSOR
)
AS
BEGIN
    OPEN cur_out FOR
    SELECT si.STOCKOUT_ID,
           e.USERNAME AS EmpUsername,
           si.OUT_DATE,
           si.NOTE
    FROM APP.STOCK_OUT si
    JOIN APP.EMPLOYEE e ON si.EMP_ID = e.EMP_ID
    ORDER BY si.STOCKOUT_ID;
END GET_ALL_EXPORTS;

/

  GRANT EXECUTE ON "APP"."GET_ALL_EXPORTS" TO "ROLE_THUKHO";
  GRANT EXECUTE ON "APP"."GET_ALL_EXPORTS" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure GET_ALL_IMPORTS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_ALL_IMPORTS" (
    cur_out OUT SYS_REFCURSOR
)
AS
BEGIN
    OPEN cur_out FOR
    SELECT si.STOCKIN_ID,
           e.USERNAME AS EmpUsername,
           si.IN_DATE,
           si.NOTE
    FROM APP.STOCK_IN si
    JOIN APP.EMPLOYEE e ON si.EMP_ID = e.EMP_ID
    ORDER BY si.STOCKIN_ID;
END GET_ALL_IMPORTS;

/

  GRANT EXECUTE ON "APP"."GET_ALL_IMPORTS" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."GET_ALL_IMPORTS" TO "ROLE_THUKHO";
--------------------------------------------------------
--  DDL for Procedure GET_ALL_ORDERS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_ALL_ORDERS" (
    cur_out OUT SYS_REFCURSOR
)
AS
BEGIN
    OPEN cur_out FOR
    SELECT 
        o.ORDER_ID,
        o.CUSTOMER_PHONE,
        recv.USERNAME AS ReceiverEmpName,
        hand.USERNAME AS HandlerEmpName,
        o.ORDER_TYPE,
        o.RECEIVED_DATE,
        o.STATUS,
        o.DESCRIPTION
    FROM ORDERS o
    LEFT JOIN EMPLOYEE recv ON o.RECEIVER_EMP = recv.EMP_ID
    LEFT JOIN EMPLOYEE hand ON o.HANDLER_EMP = hand.EMP_ID
    ORDER BY o.RECEIVED_DATE DESC;
END GET_ALL_ORDERS;

/

  GRANT EXECUTE ON "APP"."GET_ALL_ORDERS" TO "ROLE_KHACHHANG";
  GRANT EXECUTE ON "APP"."GET_ALL_ORDERS" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."GET_ALL_ORDERS" TO "ROLE_TIEPTAN";
--------------------------------------------------------
--  DDL for Procedure GET_ALL_PART
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_ALL_PART" (
    p_cursor OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN p_cursor FOR
        SELECT
            PART_ID,
            NAME,
            MANUFACTURER,
            SERIAL,
            STATUS,
            STOCK_IN_ID,
            ORDER_ID,
            PRICE
        FROM
            PART;
END get_all_part;

/

  GRANT EXECUTE ON "APP"."GET_ALL_PART" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure GET_ALL_PART_IN_STOCK
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_ALL_PART_IN_STOCK" (
    p_cursor OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN p_cursor FOR
        SELECT
            PART_ID,
            NAME,
            MANUFACTURER,
            SERIAL,
            STATUS,
            STOCK_IN_ID,
            ORDER_ID,
            PRICE
        FROM
            PART
        WHERE
            STATUS = 'Trong kho';
END GET_ALL_PART_IN_STOCK;

/

  GRANT EXECUTE ON "APP"."GET_ALL_PART_IN_STOCK" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure GET_ALL_PART_REQUESTS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_ALL_PART_REQUESTS" (
    cur_out OUT SYS_REFCURSOR
)
AS
BEGIN
    OPEN cur_out FOR
    SELECT 
        pr.REQUEST_ID,
        pr.ORDER_ID,
        pr.EMP_ID,
        e.USERNAME AS EmpUsername,
        pr.REQUEST_DATE,
        pr.STATUS
    FROM PART_REQUEST pr
    LEFT JOIN EMPLOYEE e ON pr.EMP_ID = e.EMP_ID
    ORDER BY pr.REQUEST_DATE DESC;
END GET_ALL_PART_REQUESTS;

/

  GRANT EXECUTE ON "APP"."GET_ALL_PART_REQUESTS" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure GET_ALL_PROFILES_WITH_LIMITS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_ALL_PROFILES_WITH_LIMITS" (
    cur_out OUT SYS_REFCURSOR
)
AS
BEGIN
    OPEN cur_out FOR
        SELECT PROFILE,
               RESOURCE_NAME,
               LIMIT
        FROM DBA_PROFILES
        WHERE RESOURCE_NAME IN ('FAILED_LOGIN_ATTEMPTS','PASSWORD_LIFE_TIME','PASSWORD_GRACE_TIME','PASSWORD_LOCK_TIME')
        ORDER BY PROFILE, RESOURCE_NAME;
END GET_ALL_PROFILES_WITH_LIMITS;

/

  GRANT EXECUTE ON "APP"."GET_ALL_PROFILES_WITH_LIMITS" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure GET_ALL_ROLES
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_ALL_ROLES" (p_cursor OUT SYS_REFCURSOR)
AS
BEGIN
    OPEN p_cursor FOR
        SELECT ROLE FROM DBA_ROLES;
END;

/

  GRANT EXECUTE ON "APP"."GET_ALL_ROLES" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure GET_ALL_SERVICES
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_ALL_SERVICES" (
    p_service_cursor OUT SYS_REFCURSOR -- Khai báo tham số OUT là REF CURSOR
)
AS
BEGIN
    -- Mở con trỏ và thực hiện câu lệnh SELECT
    OPEN p_service_cursor FOR
        SELECT 
            service_id,
            name, 
            description, 
            price
        FROM 
            SERVICE
        ORDER BY 
            service_id;
END GET_ALL_SERVICES;

/

  GRANT EXECUTE ON "APP"."GET_ALL_SERVICES" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."GET_ALL_SERVICES" TO "ROLE_TIEPTAN";
--------------------------------------------------------
--  DDL for Procedure GET_ALL_USERS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_ALL_USERS" (p_cursor OUT SYS_REFCURSOR)
AS
BEGIN
    OPEN p_cursor FOR
        SELECT USERNAME FROM DBA_USERS;
END;

/

  GRANT EXECUTE ON "APP"."GET_ALL_USERS" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure GET_ALL_USERS_WITH_PROFILE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_ALL_USERS_WITH_PROFILE" (
    cur_out OUT SYS_REFCURSOR
)
AS
BEGIN
    OPEN cur_out FOR
        SELECT USERNAME, PROFILE
        FROM DBA_USERS
        ORDER BY PROFILE, USERNAME;
END GET_ALL_USERS_WITH_PROFILE;

/

  GRANT EXECUTE ON "APP"."GET_ALL_USERS_WITH_PROFILE" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure GET_BY_ORDER_TYPE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_BY_ORDER_TYPE" (
    p_order_type IN VARCHAR2,
    cur_out OUT SYS_REFCURSOR
)
AS
BEGIN
    OPEN cur_out FOR
    SELECT 
        o.ORDER_ID,
        o.CUSTOMER_PHONE,
        recv.USERNAME AS ReceiverEmpName,
        hand.USERNAME AS HandlerEmpName,
        o.ORDER_TYPE,
        o.RECEIVED_DATE,
        o.STATUS,
        o.DESCRIPTION
    FROM ORDERS o
    LEFT JOIN EMPLOYEE recv ON o.RECEIVER_EMP = recv.EMP_ID
    LEFT JOIN EMPLOYEE hand ON o.HANDLER_EMP = hand.EMP_ID
    WHERE o.ORDER_TYPE = p_order_type
    ORDER BY o.RECEIVED_DATE DESC;
END GET_BY_ORDER_TYPE;

/

  GRANT EXECUTE ON "APP"."GET_BY_ORDER_TYPE" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."GET_BY_ORDER_TYPE" TO "ROLE_TIEPTAN";
--------------------------------------------------------
--  DDL for Procedure GET_EMPLOYEE_BY_ID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_EMPLOYEE_BY_ID" (
    p_empid  IN  NUMBER,
    p_cursor OUT SYS_REFCURSOR
)
AS
BEGIN
    OPEN p_cursor FOR
        SELECT e.EMP_ID,
               e.FULL_NAME,
               e.USERNAME,
               e.EMAIL,
               e.PHONE,
               -- Lấy trạng thái từ DBA_USERS
               (SELECT d.ACCOUNT_STATUS
                FROM DBA_USERS d
                WHERE d.USERNAME = UPPER(e.USERNAME)) AS STATUS
        FROM APP.EMPLOYEE e
        WHERE e.EMP_ID = p_empid;
END;

/
--------------------------------------------------------
--  DDL for Procedure GET_EMPLOYEE_ID_BY_USERNAME
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_EMPLOYEE_ID_BY_USERNAME" (
    p_username IN  VARCHAR2,
    p_emp_id  OUT NUMBER
)
AS
BEGIN
    SELECT EMP_ID
      INTO p_emp_id
      FROM APP.EMPLOYEE
     WHERE USERNAME = p_username;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20001, 'Username không tồn tại: ' || p_username);
    WHEN TOO_MANY_ROWS THEN
        RAISE_APPLICATION_ERROR(-20002, 'Có nhiều hơn một user trùng username: ' || p_username);
END GET_EMPLOYEE_ID_BY_USERNAME;

/

  GRANT EXECUTE ON "APP"."GET_EMPLOYEE_ID_BY_USERNAME" TO "ROLE_KITHUATVIEN";
  GRANT EXECUTE ON "APP"."GET_EMPLOYEE_ID_BY_USERNAME" TO "ROLE_TIEPTAN";
  GRANT EXECUTE ON "APP"."GET_EMPLOYEE_ID_BY_USERNAME" TO "ROLE_THUKHO";
  GRANT EXECUTE ON "APP"."GET_EMPLOYEE_ID_BY_USERNAME" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure GET_EMPLOYEE_NAME_BY_ID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_EMPLOYEE_NAME_BY_ID" (
    p_empid IN NUMBER,
    p_emp_name OUT VARCHAR2
)
AS
BEGIN
    SELECT USERNAME
      INTO p_emp_name
      FROM APP.EMPLOYEE
     WHERE EMP_ID = p_empid;
EXCEPTION
    WHEN NO_DATA_FOUND THEN
        p_emp_name := 'Unknown';
    WHEN TOO_MANY_ROWS THEN
        p_emp_name := 'Multiple Employees';
END GET_EMPLOYEE_NAME_BY_ID;

/
--------------------------------------------------------
--  DDL for Procedure GET_EMPLOYEE_PUBLIC_KEY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_EMPLOYEE_PUBLIC_KEY" (
    p_emp_id    IN  NUMBER,
    p_pub_key   OUT CLOB
) AS
BEGIN
    SELECT PUBLIC_KEY
    INTO p_pub_key
    FROM APP.EMPLOYEE
    WHERE EMP_ID = p_emp_id;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        p_pub_key := NULL;
END GET_EMPLOYEE_PUBLIC_KEY;

/

  GRANT EXECUTE ON "APP"."GET_EMPLOYEE_PUBLIC_KEY" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."GET_EMPLOYEE_PUBLIC_KEY" TO "ROLE_THUKHO";
--------------------------------------------------------
--  DDL for Procedure GET_EMP_ID_FROM_STOCKIN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_EMP_ID_FROM_STOCKIN" (
    p_stockin_id  IN  NUMBER,
    p_emp_id      OUT NUMBER
) AS
BEGIN
    SELECT EMP_ID
    INTO p_emp_id
    FROM APP.STOCK_IN
    WHERE STOCKIN_ID = p_stockin_id;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        p_emp_id := NULL;
END GET_EMP_ID_FROM_STOCKIN;

/

  GRANT EXECUTE ON "APP"."GET_EMP_ID_FROM_STOCKIN" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."GET_EMP_ID_FROM_STOCKIN" TO "ROLE_THUKHO";
--------------------------------------------------------
--  DDL for Procedure GET_EMP_ID_FROM_STOCKOUT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_EMP_ID_FROM_STOCKOUT" (
    p_stockout_id IN NUMBER,
    p_emp_id      OUT NUMBER
)
AS
BEGIN
    SELECT EMP_ID
    INTO p_emp_id
    FROM APP.STOCK_OUT
    WHERE STOCKOUT_ID = p_stockout_id;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        p_emp_id := NULL; -- Trả về NULL nếu không tìm thấy ID
END GET_EMP_ID_FROM_STOCKOUT;

/

  GRANT EXECUTE ON "APP"."GET_EMP_ID_FROM_STOCKOUT" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."GET_EMP_ID_FROM_STOCKOUT" TO "ROLE_THUKHO";
--------------------------------------------------------
--  DDL for Procedure GET_EXPORT_BY_ID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_EXPORT_BY_ID" (
    p_stockout_id IN NUMBER,
    cur_out OUT SYS_REFCURSOR
)
AS
BEGIN
    OPEN cur_out FOR
        SELECT  
            -- Thông tin Header (Phiếu xuất kho)
            so.STOCKOUT_ID      AS "StockOutId",
            e.FULL_NAME         AS "EmpUsername", -- Đổi từ Username sang Name
            so.OUT_DATE         AS "OutDate",
            so.NOTE             AS "Note",
            p.NAME              AS "PartName", 
            p.MANUFACTURER      AS "Manufacturer",
            p.SERIAL            AS "Serial",
            NVL(p.PRICE, 0)     AS "Price" -- Lấy giá từ bảng PART
        FROM 
            APP.STOCK_OUT so
        JOIN 
            APP.EMPLOYEE e 
            ON so.EMP_ID = e.EMP_ID
        JOIN 
            APP.STOCK_OUT_ITEM soi -- Bảng liên kết
            ON so.STOCKOUT_ID = soi.STOCKOUT_ID
        JOIN 
            APP.PART p             -- Bảng chi tiết linh kiện
            ON soi.PART_ID = p.PART_ID
        WHERE 
            so.STOCKOUT_ID = p_stockout_id;
END GET_EXPORT_BY_ID;

/

  GRANT EXECUTE ON "APP"."GET_EXPORT_BY_ID" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."GET_EXPORT_BY_ID" TO "ROLE_THUKHO";
--------------------------------------------------------
--  DDL for Procedure GET_IMPORT_BY_ID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_IMPORT_BY_ID" (
    p_stockin_id IN NUMBER,
    cur_out OUT SYS_REFCURSOR
)
AS
BEGIN
    OPEN cur_out FOR
    SELECT 
        si.STOCKIN_ID       AS "StockInId",
        e.FULL_NAME         AS "EmpUsername",
        si.IN_DATE          AS "InDate",
        si.NOTE             AS "Note",
        sii.PART_NAME       AS "PartName",
        sii.MANUFACTURER    AS "Manufacturer",
        sii.SERIAL          AS "Serial",
        NVL(sii.PRICE, 0)  AS "Price"
    FROM APP.STOCK_IN si
    LEFT JOIN APP.STOCK_IN_ITEM sii 
        ON si.STOCKIN_ID = sii.STOCKIN_ID
    LEFT JOIN APP.EMPLOYEE e
        ON si.EMP_ID = e.EMP_ID
    WHERE si.STOCKIN_ID = p_stockin_id;
END GET_IMPORT_BY_ID;

/

  GRANT EXECUTE ON "APP"."GET_IMPORT_BY_ID" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."GET_IMPORT_BY_ID" TO "ROLE_THUKHO";
--------------------------------------------------------
--  DDL for Procedure GET_ORDER_BY_ID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_ORDER_BY_ID" (
    p_order_id IN ORDERS.ORDER_ID%TYPE,
    cur_out OUT SYS_REFCURSOR
)
AS
BEGIN
    OPEN cur_out FOR
    SELECT 
        o.ORDER_ID,
        o.CUSTOMER_PHONE,
        recv.USERNAME AS ReceiverEmpName,
        hand.USERNAME AS HandlerEmpName,
        o.ORDER_TYPE,
        o.RECEIVED_DATE,
        o.STATUS,
        o.DESCRIPTION
    FROM ORDERS o
    LEFT JOIN EMPLOYEE recv ON o.RECEIVER_EMP = recv.EMP_ID
    LEFT JOIN EMPLOYEE hand ON o.HANDLER_EMP = hand.EMP_ID
    WHERE o.ORDER_ID = p_order_id;
END GET_ORDER_BY_ID;

/

  GRANT EXECUTE ON "APP"."GET_ORDER_BY_ID" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."GET_ORDER_BY_ID" TO "ROLE_TIEPTAN";
--------------------------------------------------------
--  DDL for Procedure GET_PART_BY_ORDERID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_PART_BY_ORDERID" (
    p_order_id IN PART.ORDER_ID%TYPE,
    p_cursor OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN p_cursor FOR
        SELECT
            PART_ID,
            NAME,
            MANUFACTURER,
            SERIAL,
            STATUS,
            STOCK_IN_ID,
            ORDER_ID,
            PRICE 
        FROM
            PART
        WHERE
            ORDER_ID = p_order_id;
END get_part_by_orderId;

/
--------------------------------------------------------
--  DDL for Procedure GET_PART_BY_SERIAL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_PART_BY_SERIAL" (
    p_serial IN PART.SERIAL%TYPE,
    p_cursor OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN p_cursor FOR
        SELECT
            PART_ID,
            NAME,
            MANUFACTURER,
            SERIAL,
            STATUS,
            STOCK_IN_ID,
            ORDER_ID,
            PRICE
        FROM
            PART
        WHERE
            SERIAL = p_serial;
END get_part_by_serial;

/

  GRANT EXECUTE ON "APP"."GET_PART_BY_SERIAL" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure GET_PART_BY_STATUS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_PART_BY_STATUS" (
    p_status IN PART.STATUS%TYPE,
    p_cursor OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN p_cursor FOR
        SELECT
            PART_ID,
            NAME,
            MANUFACTURER,
            SERIAL,
            STATUS,
            STOCK_IN_ID,
            ORDER_ID,
            PRICE
        FROM
            PART
        WHERE
            STATUS = p_status;
END get_part_by_status;

/
--------------------------------------------------------
--  DDL for Procedure GET_PART_BY_STOCK
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_PART_BY_STOCK" (
    p_stock_id IN PART.STOCK_IN_ID%TYPE,
    p_cursor OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN p_cursor FOR
        SELECT
            PART_ID,
            NAME,
            MANUFACTURER,
            SERIAL,
            STATUS,
            STOCK_IN_ID,
            ORDER_ID,
            PRICE
        FROM
            PART
        WHERE
            STOCK_IN_ID = p_stock_id;
END get_part_by_stock;

/
--------------------------------------------------------
--  DDL for Procedure GET_PART_BY_STOCKINID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_PART_BY_STOCKINID" (
    p_stockin_id IN PART.STOCK_IN_ID%TYPE,
    p_cursor OUT SYS_REFCURSOR
)
IS
BEGIN
    OPEN p_cursor FOR
        SELECT
            PART_ID,
            NAME,
            MANUFACTURER,
            SERIAL,
            STATUS,
            STOCK_IN_ID,
            ORDER_ID,
            PRICE
        FROM
            PART
        WHERE
            STOCK_IN_ID = p_stockin_id;
END get_part_by_stockinid;

/
--------------------------------------------------------
--  DDL for Procedure GET_PROFILE_BY_NAME
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_PROFILE_BY_NAME" (
    p_profile_name IN VARCHAR2,
    cur_out OUT SYS_REFCURSOR
)
AS
BEGIN
    OPEN cur_out FOR
        SELECT PROFILE,
               RESOURCE_NAME,
               LIMIT
        FROM DBA_PROFILES
        WHERE PROFILE = UPPER(p_profile_name)
          AND RESOURCE_NAME IN ('FAILED_LOGIN_ATTEMPTS','PASSWORD_LIFE_TIME','PASSWORD_GRACE_TIME','PASSWORD_LOCK_TIME')
        ORDER BY RESOURCE_NAME;
END GET_PROFILE_BY_NAME;

/

  GRANT EXECUTE ON "APP"."GET_PROFILE_BY_NAME" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure GET_ROLES_OF_USER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_ROLES_OF_USER" (
    p_username IN VARCHAR2,
    p_cursor OUT SYS_REFCURSOR
)
AS
BEGIN
    OPEN p_cursor FOR
        SELECT GRANTED_ROLE
        FROM DBA_ROLE_PRIVS
        WHERE GRANTEE = UPPER(p_username);
END;

/

  GRANT EXECUTE ON "APP"."GET_ROLES_OF_USER" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure GET_SERVICES_BY_ORDER_ID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_SERVICES_BY_ORDER_ID" (
    p_order_id       IN NUMBER,              -- Tham số đầu vào: ID của đơn hàng
    p_service_cursor OUT SYS_REFCURSOR      -- Tham số đầu ra: REF CURSOR chứa danh sách dịch vụ
)
AS
BEGIN
    -- Mở con trỏ và thực hiện câu lệnh SELECT JOIN
    OPEN p_service_cursor FOR
        SELECT 
            S.SERVICE_ID,
            S.NAME, 
            S.DESCRIPTION, 
            OS.QUANTITY,      -- Số lượng dịch vụ đã đặt
            OS.PRICE AS AGREED_PRICE -- Giá dịch vụ tại thời điểm đặt hàng (từ ORDER_SERVICE)
        FROM 
            SERVICE S
        JOIN
            ORDER_SERVICE OS ON S.SERVICE_ID = OS.SERVICE_ID
        WHERE 
            OS.ORDER_ID = p_order_id -- Lọc theo Order ID
        ORDER BY
            S.SERVICE_ID;
END GET_SERVICES_BY_ORDER_ID;

/

  GRANT EXECUTE ON "APP"."GET_SERVICES_BY_ORDER_ID" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."GET_SERVICES_BY_ORDER_ID" TO "ROLE_TIEPTAN";
--------------------------------------------------------
--  DDL for Procedure GET_STOCKIN_SIGNATURE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_STOCKIN_SIGNATURE" (
    p_stockin_id   IN  NUMBER,
    p_signature    OUT CLOB
) AS
BEGIN
    SELECT SIGNATURE
    INTO p_signature
    FROM APP.STOCK_IN
    WHERE STOCKIN_ID = p_stockin_id;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        p_signature := NULL;
END GET_STOCKIN_SIGNATURE;

/

  GRANT EXECUTE ON "APP"."GET_STOCKIN_SIGNATURE" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."GET_STOCKIN_SIGNATURE" TO "ROLE_THUKHO";
--------------------------------------------------------
--  DDL for Procedure GET_STOCKOUT_SIGNATURE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_STOCKOUT_SIGNATURE" (
    p_stockout_id IN NUMBER,
    p_signature   OUT VARCHAR2 -- Hoặc CLOB nếu bạn thay đổi kiểu dữ liệu
)
AS
BEGIN
    SELECT SIGNATURE
    INTO p_signature
    FROM APP.STOCK_OUT
    WHERE STOCKOUT_ID = p_stockout_id;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        p_signature := NULL; -- Trả về NULL nếu không tìm thấy ID
END GET_STOCKOUT_SIGNATURE;

/

  GRANT EXECUTE ON "APP"."GET_STOCKOUT_SIGNATURE" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."GET_STOCKOUT_SIGNATURE" TO "ROLE_THUKHO";
--------------------------------------------------------
--  DDL for Procedure GET_UNFINISHED_ORDERS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."GET_UNFINISHED_ORDERS" (
    cur_out OUT SYS_REFCURSOR
)
AS
BEGIN
    OPEN cur_out FOR
    SELECT 
        o.ORDER_ID,
        o.CUSTOMER_PHONE,
        recv.USERNAME AS ReceiverEmpName,
        hand.USERNAME AS HandlerEmpName,
        o.ORDER_TYPE,
        o.RECEIVED_DATE,
        o.STATUS,
        o.DESCRIPTION
    FROM ORDERS o
    LEFT JOIN EMPLOYEE recv ON o.RECEIVER_EMP = recv.EMP_ID
    LEFT JOIN EMPLOYEE hand ON o.HANDLER_EMP = hand.EMP_ID
    WHERE o.STATUS != 'Đã hoàn thành'
       OR o.STATUS IS NULL       -- phòng trường hợp giá trị rỗng
    ORDER BY o.RECEIVED_DATE DESC;
END GET_UNFINISHED_ORDERS;

/
--------------------------------------------------------
--  DDL for Procedure LOCK_DB_USER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."LOCK_DB_USER" (
    p_username IN VARCHAR2
)
AS
BEGIN
    BEGIN
        EXECUTE IMMEDIATE 'ALTER USER "' || UPPER(p_username) || '" ACCOUNT LOCK';

    EXCEPTION
        WHEN OTHERS THEN
            RAISE_APPLICATION_ERROR(-20002, 'Không thể lock user ' || p_username || ': ' || SQLERRM);
    END;
END;

/

  GRANT EXECUTE ON "APP"."LOCK_DB_USER" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure LOGIN_CUSTOMER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."LOGIN_CUSTOMER" (
    p_phone        IN  VARCHAR2,
    p_password     IN  VARCHAR2,
    p_out_phone    OUT VARCHAR2,
    p_out_result   OUT VARCHAR2
) AS
    PRAGMA AUTONOMOUS_TRANSACTION;

    v_hash       VARCHAR2(256);
    v_db_hash    VARCHAR2(256);
    v_fail_count NUMBER;
BEGIN
    v_hash := HASH_PASSWORD(p_password);

    BEGIN
        SELECT PASSWORD_HASH
        INTO v_db_hash
        FROM CUSTOMER
        WHERE PHONE = p_phone;
        p_out_phone := p_phone;

        IF v_db_hash = v_hash THEN
            p_out_result := 'SUCCESS';
        ELSE
            p_out_result := 'FAILED';
        END IF;

    EXCEPTION
        WHEN NO_DATA_FOUND THEN

            p_out_phone := NULL;
            
            p_out_result := 'FAILED';
    END;
END LOGIN_CUSTOMER;

/

  GRANT EXECUTE ON "APP"."LOGIN_CUSTOMER" TO "ROLE_KHACHHANG";
--------------------------------------------------------
--  DDL for Procedure LOGIN_EMPLOYEE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."LOGIN_EMPLOYEE" (
    p_username     IN  VARCHAR2,
    p_password     IN  VARCHAR2,
    p_out_username OUT VARCHAR2,
    p_out_result   OUT VARCHAR2,
    p_out_role     OUT VARCHAR2
) AS
    PRAGMA AUTONOMOUS_TRANSACTION;

    v_hash       VARCHAR2(256);
    v_db_hash    VARCHAR2(256);
    v_status     VARCHAR2(30);
BEGIN
    v_hash := HASH_PASSWORD(p_password);

    BEGIN
        -- Lấy mật khẩu từ bảng EMPLOYEE
        SELECT PASSWORD_HASH
        INTO v_db_hash
        FROM EMPLOYEE
        WHERE USERNAME = p_username;

        p_out_username := p_username;

        -- Lấy trạng thái từ DBA_USERS
        BEGIN
            SELECT ACCOUNT_STATUS
            INTO v_status
            FROM DBA_USERS
            WHERE USERNAME = UPPER(p_username);
        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                v_status := 'UNKNOWN';
        END;

        IF v_status LIKE 'LOCKED%' THEN
            p_out_result := 'ACCOUNT LOCKED';
            p_out_role := NULL;
            RETURN;
        END IF;

        IF v_db_hash = v_hash THEN
            p_out_result := 'SUCCESS';

            -- Lấy role của user
            BEGIN
                SELECT LISTAGG(GRANTED_ROLE, ', ') WITHIN GROUP (ORDER BY GRANTED_ROLE)
                INTO p_out_role
                FROM DBA_ROLE_PRIVS
                WHERE GRANTEE = UPPER(p_username);
            EXCEPTION
                WHEN NO_DATA_FOUND THEN
                    p_out_role := NULL;
            END;

        ELSE
            p_out_result := 'FAILED';
            p_out_role := NULL;
        END IF;

    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            p_out_username := NULL;
            p_out_result := 'FAILED';
            p_out_role := NULL;
    END;
END LOGIN_EMPLOYEE;

/

  GRANT EXECUTE ON "APP"."LOGIN_EMPLOYEE" TO "ADMIN";
  GRANT EXECUTE ON "APP"."LOGIN_EMPLOYEE" TO "THUKHO";
  GRANT EXECUTE ON "APP"."LOGIN_EMPLOYEE" TO "KITHUATVIEN";
  GRANT EXECUTE ON "APP"."LOGIN_EMPLOYEE" TO "TIEPTAN";
  GRANT EXECUTE ON "APP"."LOGIN_EMPLOYEE" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."LOGIN_EMPLOYEE" TO "ROLE_KITHUATVIEN";
  GRANT EXECUTE ON "APP"."LOGIN_EMPLOYEE" TO "ROLE_TIEPTAN";
  GRANT EXECUTE ON "APP"."LOGIN_EMPLOYEE" TO "ROLE_THUKHO";
--------------------------------------------------------
--  DDL for Procedure REGISTER_CUSTOMER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."REGISTER_CUSTOMER" (
    p_phone     IN VARCHAR2,   -- dùng làm PK
    p_full_name IN VARCHAR2,
    p_password  IN VARCHAR2,
    p_email     IN VARCHAR2,
    p_address   IN VARCHAR2
)
AS
    v_hash VARCHAR2(256);
    v_pub  CLOB;
    v_priv CLOB;
    v_keys      CLOB;
    v_pwd VARCHAR2(20);
BEGIN
    -- Hash mật khẩu
    v_hash := HASH_PASSWORD(p_password);

    -- 2. Sinh cặp RSA
    v_keys := CRYPTO.RSA_GENERATE_KEYS(KEY_SIZE => 1024);

    -- 3. Tách public key (loại bỏ ****)
    v_pub := TRIM(
                SUBSTR(
                    v_keys,
                    INSTR(v_keys, 'publicKey start*****') + LENGTH('publicKey start*****'),
                    INSTR(v_keys, '****publicKey end') - (INSTR(v_keys, 'publicKey start*****') + LENGTH('publicKey start*****'))
                )
             );

    -- 4. Tách private key (loại bỏ ****)
    v_priv := TRIM(
                 SUBSTR(
                     v_keys,
                     INSTR(v_keys, 'privateKey start****') + LENGTH('privateKey start****'),
                     INSTR(v_keys, '****privateKey end') - (INSTR(v_keys, 'privateKey start****') + LENGTH('privateKey start****'))
                 )
              );
    v_pwd := HASH_PASSWORD_20CHARS(p_password);
    -- 1. Tạo Oracle DB user trước
    BEGIN
        EXECUTE IMMEDIATE 'CREATE USER "' || p_phone || '"' ||
                          ' IDENTIFIED BY "' || v_pwd || '"' ||
                          ' DEFAULT TABLESPACE USERS QUOTA UNLIMITED ON USERS';
        EXECUTE IMMEDIATE 'GRANT ROLE_KHACHHANG TO "' || p_phone || '"';
    EXCEPTION
        WHEN OTHERS THEN
            RAISE_APPLICATION_ERROR(-20002, 'Không thể tạo DB User cho Customer ' || p_phone || ': ' || SQLERRM);
    END;

    -- 2. Insert vào bảng CUSTOMER (chỉ khi tạo DB user thành công)
    BEGIN
        INSERT INTO CUSTOMER(PHONE, FULL_NAME, PASSWORD_HASH, PUBLIC_KEY, EMAIL, ADDRESS)
        VALUES (p_phone, p_full_name, v_hash, v_pub, p_email, p_address);

        COMMIT;
    EXCEPTION
        WHEN OTHERS THEN
            -- Nếu lỗi ở bước insert thì rollback + xóa DB user vừa tạo
            ROLLBACK;
            BEGIN
                EXECUTE IMMEDIATE 'DROP USER "' || p_phone || '" CASCADE';
            EXCEPTION
                WHEN OTHERS THEN NULL;
            END;
            RAISE;
    END;

END REGISTER_CUSTOMER;

/
--------------------------------------------------------
--  DDL for Procedure REGISTER_EMPLOYEE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."REGISTER_EMPLOYEE" (
    p_empid       IN NUMBER DEFAULT NULL,   
    p_full_name   IN VARCHAR2,
    p_username    IN VARCHAR2,
    p_password    IN VARCHAR2,
    p_email       IN VARCHAR2,
    p_phone       IN VARCHAR2,
    p_private_key OUT CLOB
)
AS
    v_hash      VARCHAR2(256);
    v_pub       CLOB;
    v_priv      CLOB;
    v_keys      CLOB;
    v_pwd VARCHAR2(20);
BEGIN
    -- 1. Hash mật khẩu
    v_hash := HASH_PASSWORD(p_password);

    -- 2. Sinh cặp RSA
    v_keys := CRYPTO.RSA_GENERATE_KEYS(KEY_SIZE => 1024);

    -- 3. Tách public key (loại bỏ ****)
    v_pub := TRIM(
                SUBSTR(
                    v_keys,
                    INSTR(v_keys, 'publicKey start*****') + LENGTH('publicKey start*****'),
                    INSTR(v_keys, '****publicKey end') - (INSTR(v_keys, 'publicKey start*****') + LENGTH('publicKey start*****'))
                )
             );

    -- 4. Tách private key (loại bỏ ****)
    v_priv := TRIM(
                 SUBSTR(
                     v_keys,
                     INSTR(v_keys, 'privateKey start****') + LENGTH('privateKey start****'),
                     INSTR(v_keys, '****privateKey end') - (INSTR(v_keys, 'privateKey start****') + LENGTH('privateKey start****'))
                 )
              );
    v_pwd := HASH_PASSWORD_20CHARS(p_password);
    -- 5. Tạo Oracle DB user
    BEGIN
        EXECUTE IMMEDIATE 'CREATE USER ' || p_username ||
                  ' IDENTIFIED BY "' || v_pwd || '" DEFAULT TABLESPACE USERS QUOTA UNLIMITED ON USERS';
        EXECUTE IMMEDIATE 'GRANT CONNECT, RESOURCE TO ' || p_username;
        EXECUTE IMMEDIATE 'GRANT EXECUTE ON LOGIN_EMPLOYEE TO ' || p_username;
    EXCEPTION
        WHEN OTHERS THEN
            RAISE_APPLICATION_ERROR(-20001, 'Không thể tạo DB User cho nhân viên: ' || SQLERRM);
    END;

    -- 6. Insert vào EMPLOYEE
    IF p_empid IS NULL THEN
        INSERT INTO EMPLOYEE(FULL_NAME, USERNAME, PASSWORD_HASH, PUBLIC_KEY, EMAIL, PHONE)
        VALUES (p_full_name, p_username, v_hash, v_pub, p_email, p_phone);
    ELSE
        INSERT INTO EMPLOYEE(EMP_ID, FULL_NAME, USERNAME, PASSWORD_HASH, PUBLIC_KEY, EMAIL, PHONE)
        VALUES (p_empid, p_full_name, p_username, v_hash, v_pub, p_email, p_phone);
    END IF;

    -- 7. Trả private key ra OUT param
    p_private_key := v_priv;

    COMMIT;

EXCEPTION
    WHEN OTHERS THEN
        BEGIN
            EXECUTE IMMEDIATE 'DROP USER ' || p_username || ' CASCADE';
        EXCEPTION
            WHEN OTHERS THEN NULL;
        END;
        RAISE;
END;

/

  GRANT EXECUTE ON "APP"."REGISTER_EMPLOYEE" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure REVOKE_ROLE_PROC
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."REVOKE_ROLE_PROC" (
    p_username IN VARCHAR2,
    p_role_name IN VARCHAR2
)
AS
BEGIN
    EXECUTE IMMEDIATE 'REVOKE "' || p_role_name || '" FROM "' || p_username || '"';
END;

/

  GRANT EXECUTE ON "APP"."REVOKE_ROLE_PROC" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure SIGN_STOCKIN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."SIGN_STOCKIN" (
    p_stockin_id    IN NUMBER,
    p_private_key   IN VARCHAR2,
    p_signature     OUT CLOB
) AS
    l_items_to_sign  CLOB;
    l_data_to_sign   CLOB;
    l_hash_raw       RAW(10000);
    l_hash_hex       VARCHAR2(10000);
BEGIN
    -- 1. Nối tất cả item với format cố định
    SELECT LISTAGG(
               TRIM(si.STOCKIN_ITEM_ID) || '|' ||
               TRIM(si.PART_NAME) || '|' ||
               TRIM(NVL(si.MANUFACTURER,'')) || '|' ||
               TRIM(si.SERIAL) || '|' ||
               TO_CHAR(si.PRICE,'FM9999990.00')
           , ';') WITHIN GROUP (ORDER BY si.STOCKIN_ITEM_ID)
    INTO l_items_to_sign
    FROM APP.STOCK_IN_ITEM si
    WHERE si.STOCKIN_ID = p_stockin_id;

    -- 2. Lấy header với format ngày và trim
    SELECT TRIM(s.STOCKIN_ID) || '|' || TRIM(s.EMP_ID) || '|' || TO_CHAR(s.IN_DATE,'YYYYMMDD') || '|' || TRIM(NVL(s.NOTE,''))
    INTO l_data_to_sign
    FROM APP.STOCK_IN s
    WHERE s.STOCKIN_ID = p_stockin_id;

    -- 3. Nối header + items
    l_data_to_sign := l_data_to_sign || '|' || l_items_to_sign;
    
    -- 4. Hash SHA-256
    l_hash_raw := DBMS_CRYPTO.HASH(UTL_RAW.CAST_TO_RAW(l_data_to_sign), DBMS_CRYPTO.HASH_SH256);
    l_hash_hex := RAWTOHEX(l_hash_raw);
    
    -- 5. Ký hash
    p_signature := CRYPTO.RSA_SIGN(l_hash_hex, p_private_key);
        

END SIGN_STOCKIN;

/

  GRANT EXECUTE ON "APP"."SIGN_STOCKIN" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."SIGN_STOCKIN" TO "ROLE_THUKHO";
--------------------------------------------------------
--  DDL for Procedure SIGN_STOCKOUT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."SIGN_STOCKOUT" (
    p_stockout_id   IN NUMBER,              -- ID của phiếu xuất kho
    p_private_key   IN VARCHAR2,            -- Private Key dùng để ký
    p_signature     OUT CLOB                -- Chữ ký đầu ra
) AS
    l_items_to_sign  CLOB;
    l_data_to_sign   CLOB;
    l_hash_raw       RAW(10000);
    l_hash_hex       VARCHAR2(10000);
BEGIN
    -- 1. Nối tất cả item với format cố định (Lấy data từ bảng PART)
    SELECT LISTAGG(
                TRIM(p.PART_ID) || '|' ||
                TRIM(p.NAME) || '|' ||
                TRIM(NVL(p.MANUFACTURER,'')) || '|' ||
                TRIM(p.SERIAL) || '|' ||
                TO_CHAR(p.PRICE,'FM9999990.00')
            , ';') WITHIN GROUP (ORDER BY p.PART_ID)
    INTO l_items_to_sign
    FROM APP.STOCK_OUT_ITEM soi
    JOIN APP.PART p ON soi.PART_ID = p.PART_ID -- Join với PART để lấy chi tiết
    WHERE soi.STOCKOUT_ID = p_stockout_id;

    -- 2. Lấy header (STOCKOUT_ID, ORDER_ID, EMP_ID, OUT_DATE, NOTE)
    SELECT TRIM(s.STOCKOUT_ID) || '|' || TRIM(s.ORDER_ID) || '|' || TRIM(s.EMP_ID) || '|' || TO_CHAR(s.OUT_DATE,'YYYYMMDD') || '|' || TRIM(NVL(s.NOTE,''))
    INTO l_data_to_sign
    FROM APP.STOCK_OUT s
    WHERE s.STOCKOUT_ID = p_stockout_id;

    -- 3. Nối header + items
    l_data_to_sign := l_data_to_sign || '|' || l_items_to_sign;

    -- 4. Hash SHA-256
    l_hash_raw := DBMS_CRYPTO.HASH(UTL_RAW.CAST_TO_RAW(l_data_to_sign), DBMS_CRYPTO.HASH_SH256);
    l_hash_hex := RAWTOHEX(l_hash_raw);

    -- 5. Ký hash
    p_signature := CRYPTO.RSA_SIGN(l_hash_hex, p_private_key);

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20001, 'Không tìm thấy phiếu xuất kho với ID: ' || p_stockout_id);
    WHEN OTHERS THEN
        RAISE;
END SIGN_STOCKOUT;

/

  GRANT EXECUTE ON "APP"."SIGN_STOCKOUT" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."SIGN_STOCKOUT" TO "ROLE_THUKHO";
--------------------------------------------------------
--  DDL for Procedure UNLOCK_DB_USER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."UNLOCK_DB_USER" (
    p_username IN VARCHAR2
)
AS
BEGIN
    BEGIN
        EXECUTE IMMEDIATE 'ALTER USER "' || UPPER(p_username) || '" ACCOUNT UNLOCK';

    EXCEPTION
        WHEN OTHERS THEN
            RAISE_APPLICATION_ERROR(-20001, 'Không thể unlock user ' || p_username || ': ' || SQLERRM);
    END;
END;

/

  GRANT EXECUTE ON "APP"."UNLOCK_DB_USER" TO "ROLE_ADMIN";
--------------------------------------------------------
--  DDL for Procedure UPDATE_ORDER_STATUS_WAIT_PART
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."UPDATE_ORDER_STATUS_WAIT_PART" (
    p_order_id IN NUMBER
)
AS
BEGIN
    -- Cập nhật trạng thái trong bảng PART_REQUEST (hoặc bảng ORDER)
    UPDATE ORDERS
       SET STATUS = 'Đang chờ linh kiện'
     WHERE ORDER_ID = p_order_id;

    COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        ROLLBACK;
        RAISE;
END UPDATE_ORDER_STATUS_WAIT_PART;

/
--------------------------------------------------------
--  DDL for Procedure UPDATE_STOCKIN_SIGNATURE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."UPDATE_STOCKIN_SIGNATURE" (
    p_stockin_id IN NUMBER,
    p_signature  IN VARCHAR2
) AS
BEGIN
    UPDATE APP.STOCK_IN
    SET SIGNATURE = p_signature
    WHERE STOCKIN_ID = p_stockin_id;
END UPDATE_STOCKIN_SIGNATURE;

/

  GRANT EXECUTE ON "APP"."UPDATE_STOCKIN_SIGNATURE" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."UPDATE_STOCKIN_SIGNATURE" TO "ROLE_THUKHO";
--------------------------------------------------------
--  DDL for Procedure UPDATE_STOCKOUT_SIGNATURE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."UPDATE_STOCKOUT_SIGNATURE" (
    p_stockout_id IN NUMBER,
    p_signature   IN VARCHAR2
) AS
BEGIN
    UPDATE APP.STOCK_OUT
    SET SIGNATURE = p_signature
    WHERE STOCKOUT_ID = p_stockout_id;

    IF SQL%NOTFOUND THEN
        RAISE_APPLICATION_ERROR(-20002, 'Không tìm thấy phiếu xuất kho để cập nhật chữ ký: ' || p_stockout_id);
    END IF;
END UPDATE_STOCKOUT_SIGNATURE;

/

  GRANT EXECUTE ON "APP"."UPDATE_STOCKOUT_SIGNATURE" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."UPDATE_STOCKOUT_SIGNATURE" TO "ROLE_THUKHO";
--------------------------------------------------------
--  DDL for Procedure VERIFY_STOCKIN_SIGNATURE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."VERIFY_STOCKIN_SIGNATURE" (
    p_stockin_id   IN NUMBER,
    p_public_key   IN VARCHAR2,
    p_signature    IN CLOB,
    p_is_valid     OUT NUMBER
) AS
    l_items_to_sign  CLOB;
    l_data_to_sign   CLOB;
    l_hash_raw       RAW(32);
    l_hash_hex       VARCHAR2(64);
    l_verified       BOOLEAN;
BEGIN
    -- 1. Nối tất cả item với cùng format như SIGN
    SELECT LISTAGG(
               TRIM(si.STOCKIN_ITEM_ID) || '|' ||
               TRIM(si.PART_NAME) || '|' ||
               TRIM(NVL(si.MANUFACTURER,'')) || '|' ||
               TRIM(si.SERIAL) || '|' ||
               TO_CHAR(si.PRICE,'FM9999990.00')
           , ';') WITHIN GROUP (ORDER BY si.STOCKIN_ITEM_ID)
    INTO l_items_to_sign
    FROM APP.STOCK_IN_ITEM si
    WHERE si.STOCKIN_ID = p_stockin_id;

    -- 2. Lấy header với format ngày và trim
    SELECT TRIM(s.STOCKIN_ID) || '|' || TRIM(s.EMP_ID) || '|' || TO_CHAR(s.IN_DATE,'YYYYMMDD') || '|' || TRIM(NVL(s.NOTE,''))
    INTO l_data_to_sign
    FROM APP.STOCK_IN s
    WHERE s.STOCKIN_ID = p_stockin_id;

    -- 3. Nối header + items
    l_data_to_sign := l_data_to_sign || '|' || l_items_to_sign;

    -- 4. Hash SHA-256
    l_hash_raw := DBMS_CRYPTO.HASH(UTL_RAW.CAST_TO_RAW(l_data_to_sign), DBMS_CRYPTO.HASH_SH256);
    l_hash_hex := RAWTOHEX(l_hash_raw);

    -- 5. Verify với Java RSA_VERIFY
    l_verified := CRYPTO.RSA_VERIFY(l_hash_hex, p_signature, p_public_key);

    IF l_verified THEN
        p_is_valid := 1;  -- valid
    ELSE
        p_is_valid := 0;  -- invalid
    END IF;
END VERIFY_STOCKIN_SIGNATURE;

/

  GRANT EXECUTE ON "APP"."VERIFY_STOCKIN_SIGNATURE" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."VERIFY_STOCKIN_SIGNATURE" TO "ROLE_THUKHO";
--------------------------------------------------------
--  DDL for Procedure VERIFY_STOCKOUT_SIGNATURE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APP"."VERIFY_STOCKOUT_SIGNATURE" (
    p_stockout_id   IN NUMBER,              -- ID của phiếu xuất kho
    p_public_key    IN VARCHAR2,            -- Public Key dùng để xác minh
    p_signature     IN CLOB,                -- Chữ ký cần xác minh
    p_is_valid      OUT NUMBER              -- Kết quả: 1 (Hợp lệ) hoặc 0 (Không hợp lệ)
) AS
    l_items_to_sign  CLOB;
    l_data_to_sign   CLOB;
    l_hash_raw       RAW(32);
    l_hash_hex       VARCHAR2(64);
    l_verified       BOOLEAN;
BEGIN
    -- 1. Nối tất cả item với cùng format như SIGN (Lấy data từ bảng PART)
    SELECT LISTAGG(
                TRIM(p.PART_ID) || '|' ||
                TRIM(p.NAME) || '|' ||
                TRIM(NVL(p.MANUFACTURER,'')) || '|' ||
                TRIM(p.SERIAL) || '|' ||
                TO_CHAR(p.PRICE,'FM9999990.00')
            , ';') WITHIN GROUP (ORDER BY p.PART_ID)
    INTO l_items_to_sign
    FROM APP.STOCK_OUT_ITEM soi
    JOIN APP.PART p ON soi.PART_ID = p.PART_ID
    WHERE soi.STOCKOUT_ID = p_stockout_id;

    -- 2. Lấy header (STOCKOUT_ID, ORDER_ID, EMP_ID, OUT_DATE, NOTE)
    SELECT TRIM(s.STOCKOUT_ID) || '|' || TRIM(s.ORDER_ID) || '|' || TRIM(s.EMP_ID) || '|' || TO_CHAR(s.OUT_DATE,'YYYYMMDD') || '|' || TRIM(NVL(s.NOTE,''))
    INTO l_data_to_sign
    FROM APP.STOCK_OUT s
    WHERE s.STOCKOUT_ID = p_stockout_id;

    -- 3. Nối header + items
    l_data_to_sign := l_data_to_sign || '|' || l_items_to_sign;

    -- 4. Hash SHA-256
    l_hash_raw := DBMS_CRYPTO.HASH(UTL_RAW.CAST_TO_RAW(l_data_to_sign), DBMS_CRYPTO.HASH_SH256);
    l_hash_hex := RAWTOHEX(l_hash_raw);

    -- 5. Verify với Java RSA_VERIFY
    l_verified := CRYPTO.RSA_VERIFY(l_hash_hex, p_signature, p_public_key);

    IF l_verified THEN
        p_is_valid := 1;  -- valid
    ELSE
        p_is_valid := 0;  -- invalid
    END IF;

EXCEPTION
    WHEN NO_DATA_FOUND THEN
        -- Nếu không tìm thấy STOCK_OUT, coi là không hợp lệ
        p_is_valid := 0;
    WHEN OTHERS THEN
        -- Xử lý lỗi khác (ví dụ: lỗi CRYPTO), coi là không hợp lệ
        p_is_valid := 0;
END VERIFY_STOCKOUT_SIGNATURE;

/

  GRANT EXECUTE ON "APP"."VERIFY_STOCKOUT_SIGNATURE" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."VERIFY_STOCKOUT_SIGNATURE" TO "ROLE_THUKHO";
--------------------------------------------------------
--  DDL for Package APP_CTX_PKG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE PACKAGE "APP"."APP_CTX_PKG" AS
  PROCEDURE set_role(p_role_name IN VARCHAR2);
  PROCEDURE set_emp(p_emp_id IN NUMBER);
  PROCEDURE set_customer(p_customer_phone IN VARCHAR2);
END APP_CTX_PKG;

/

  GRANT EXECUTE ON "APP"."APP_CTX_PKG" TO PUBLIC;
--------------------------------------------------------
--  DDL for Package CRYPTO
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE PACKAGE "APP"."CRYPTO" AS 
FUNCTION RSA_ENCRYPT(PLAIN_TEXT VARCHAR2,PRIVATE_KEY VARCHAR2) RETURN VARCHAR2
AS
LANGUAGE JAVA NAME 'com/dishtavar/crypto4ora/RSAUtil.encrypt (java.lang.String,java.lang.String) return java.lang.String';


FUNCTION RSA_DECRYPT(ENCRYPTED_TEXT VARCHAR2,PUBLIC_KEY VARCHAR2) RETURN VARCHAR2
AS
LANGUAGE JAVA NAME 'com/dishtavar/crypto4ora/RSAUtil.decrypt (java.lang.String,java.lang.String) return java.lang.String';


FUNCTION RSA_SIGN(HASH_MESSAGE VARCHAR2,PUBLIC_KEY VARCHAR2) RETURN VARCHAR2
AS
LANGUAGE JAVA NAME 'com/dishtavar/crypto4ora/RSAUtil.sign (java.lang.String,java.lang.String) return java.lang.String';


FUNCTION RSA_VERIFY(PLAIN_HASH VARCHAR2,SIGNNED_HASH VARCHAR2,PRIVATE_KEY VARCHAR2) RETURN BOOLEAN
AS
LANGUAGE JAVA NAME 'com/dishtavar/crypto4ora/RSAUtil.verify (java.lang.String,java.lang.String,java.lang.String) return java.lang.Boolean';

FUNCTION RSA_GENERATE_KEYS(KEY_SIZE NUMBER) RETURN VARCHAR2
AS
LANGUAGE JAVA NAME 'com/dishtavar/crypto4ora/GenerateKey.generateRSAKeys (java.lang.Integer) return java.lang.String';

END CRYPTO;

/
--------------------------------------------------------
--  DDL for Package Body APP_CTX_PKG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE PACKAGE BODY "APP"."APP_CTX_PKG" AS
  PROCEDURE set_role(p_role_name IN VARCHAR2) IS
  BEGIN
    DBMS_SESSION.SET_CONTEXT('APP_CTX','ROLE_NAME', UPPER(p_role_name));
  END;

  PROCEDURE set_emp(p_emp_id IN NUMBER) IS
  BEGIN
    DBMS_SESSION.SET_CONTEXT('APP_CTX','EMP_ID', TO_CHAR(p_emp_id));
  END;

  PROCEDURE set_customer(p_customer_phone IN VARCHAR2) IS
  BEGIN
    DBMS_SESSION.SET_CONTEXT('APP_CTX','CUSTOMER_PHONE', p_customer_phone);
  END;
END APP_CTX_PKG;

/

  GRANT EXECUTE ON "APP"."APP_CTX_PKG" TO PUBLIC;
--------------------------------------------------------
--  DDL for Function APPOINTMENT_VPD_PREDICATE
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "APP"."APPOINTMENT_VPD_PREDICATE" (
  p_schema  IN VARCHAR2,
  p_object  IN VARCHAR2
) RETURN VARCHAR2
AS
  v_role VARCHAR2(100) := SYS_CONTEXT('APP_CTX','ROLE_NAME');
  v_cus  VARCHAR2(100) := SYS_CONTEXT('APP_CTX','CUSTOMER_PHONE');
BEGIN
  IF v_role IS NULL THEN
    RETURN '1=0';
  END IF;

  IF v_role IN ('ROLE_ADMIN','ROLE_TIEPTAN') THEN
    RETURN '1=1';
  END IF;

  IF v_role = 'ROLE_KHACHHANG' THEN
    IF v_cus IS NULL THEN
      RETURN '1=0';
    END IF;
    RETURN 'CUSTOMER_PHONE = ''' || REPLACE(v_cus,'''','''''') || '''';
  END IF;

  -- THUKHO, KITHUATVIEN and others: deny
  RETURN '1=0';
END;

/
--------------------------------------------------------
--  DDL for Function APPOINTMENT_VPD_PREDICATE_DEL
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "APP"."APPOINTMENT_VPD_PREDICATE_DEL" (
  p_schema  IN VARCHAR2,
  p_object  IN VARCHAR2
) RETURN VARCHAR2
AS
BEGIN
  RETURN '1=0';
END;

/
--------------------------------------------------------
--  DDL for Function CUSTOMER_VPD_PREDICATE
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "APP"."CUSTOMER_VPD_PREDICATE" (
  p_schema IN VARCHAR2,
  p_object IN VARCHAR2
) RETURN VARCHAR2
AS
  v_role  VARCHAR2(100) := SYS_CONTEXT('APP_CTX','ROLE_NAME');
  v_cus   VARCHAR2(100) := SYS_CONTEXT('APP_CTX','CUSTOMER_PHONE');
BEGIN
  -- ADMIN, TIEPTAN: xem full
  IF v_role IN ('ROLE_ADMIN', 'ROLE_TIEPTAN') THEN
    RETURN '1=1';
  END IF;

  -- THUKHO, KITHUATVIEN: không được xem
  IF v_role IN ('ROLE_THUKHO', 'ROLE_KITHUATVIEN') THEN
    RETURN '1=0';
  END IF;

  -- KHACHHANG: chỉ xem của cá nhân theo số điện thoại trong context
  IF v_role = 'ROLE_KHACHHANG' THEN
    -- Cột trên bảng CUSTOMER giả định là PHONE
    RETURN 'PHONE = ''' || REPLACE(v_cus,'''','''''') || '''';
  END IF;

  -- Mặc định: chặn
  RETURN '1=0';
END CUSTOMER_VPD_PREDICATE;

/
--------------------------------------------------------
--  DDL for Function EMPLOYEE_VPD_PREDICATE
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "APP"."EMPLOYEE_VPD_PREDICATE" (
  p_schema IN VARCHAR2,
  p_object IN VARCHAR2
) RETURN VARCHAR2
AS
  v_role  VARCHAR2(100) := SYS_CONTEXT('APP_CTX','ROLE_NAME');
BEGIN
  -- ADMIN, TIEPTAN: xem full
  IF v_role IN ('ROLE_ADMIN', 'ROLE_TIEPTAN') THEN
    RETURN '1=1';
  END IF;

  -- THUKHO, KITHUATVIEN, KHACHHANG: không được xem
  IF v_role IN ('ROLE_THUKHO', 'ROLE_KITHUATVIEN', 'ROLE_KHACHHANG') THEN
    RETURN '1=0';
  END IF;

  -- Mặc định: chặn
  RETURN '1=0';
END EMPLOYEE_VPD_PREDICATE;

/
--------------------------------------------------------
--  DDL for Function GET_EMPLOYEE_ROLES_BY_USERNAME
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "APP"."GET_EMPLOYEE_ROLES_BY_USERNAME" (
    p_username IN VARCHAR2
)
RETURN VARCHAR2
AS
    -- Biến để chứa chuỗi các role
    v_roles_list VARCHAR2(4000); 
BEGIN
    -- Sử dụng DBA_ROLE_PRIVS để lấy tất cả các role được cấp cho user
    -- LISTAGG dùng để gộp các dòng thành một chuỗi duy nhất, phân tách bằng ', '
    SELECT LISTAGG(GRANTED_ROLE, ', ') WITHIN GROUP (ORDER BY GRANTED_ROLE)
    INTO v_roles_list
    FROM DBA_ROLE_PRIVS
    -- Tên người dùng trong DBA_ROLE_PRIVS luôn là chữ hoa
    WHERE GRANTEE = UPPER(p_username); 

    RETURN v_roles_list;

EXCEPTION
    -- Xử lý trường hợp không tìm thấy role nào (ví dụ: user không tồn tại hoặc chưa được gán role)
    WHEN NO_DATA_FOUND THEN
        RETURN NULL;
    -- Xử lý các lỗi khác (ví dụ: không có quyền SELECT trên DBA_ROLE_PRIVS)
    WHEN OTHERS THEN
        -- Tùy chọn: Ghi log lỗi tại đây
        RETURN NULL;
END GET_EMPLOYEE_ROLES_BY_USERNAME; -- ✅ ĐÃ SỬA: BỎ TIỀN TỐ APP.

/

  GRANT EXECUTE ON "APP"."GET_EMPLOYEE_ROLES_BY_USERNAME" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."GET_EMPLOYEE_ROLES_BY_USERNAME" TO "ROLE_KITHUATVIEN";
  GRANT EXECUTE ON "APP"."GET_EMPLOYEE_ROLES_BY_USERNAME" TO "ROLE_TIEPTAN";
  GRANT EXECUTE ON "APP"."GET_EMPLOYEE_ROLES_BY_USERNAME" TO "ROLE_THUKHO";
--------------------------------------------------------
--  DDL for Function HASH_PASSWORD
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "APP"."HASH_PASSWORD" (p_password VARCHAR2) RETURN VARCHAR2 IS
    v_raw RAW(32);
BEGIN
    v_raw := DBMS_CRYPTO.HASH(
        UTL_I18N.STRING_TO_RAW(p_password, 'AL32UTF8'),
        DBMS_CRYPTO.HASH_SH256
    );
    RETURN RAWTOHEX(v_raw);
END;

/

  GRANT EXECUTE ON "APP"."HASH_PASSWORD" TO "ROLE_ADMIN";
  GRANT EXECUTE ON "APP"."HASH_PASSWORD" TO "ROLE_KITHUATVIEN";
  GRANT EXECUTE ON "APP"."HASH_PASSWORD" TO "ROLE_TIEPTAN";
  GRANT EXECUTE ON "APP"."HASH_PASSWORD" TO "ROLE_THUKHO";
--------------------------------------------------------
--  DDL for Function HASH_PASSWORD_20CHARS
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "APP"."HASH_PASSWORD_20CHARS" (p_password VARCHAR2) 
RETURN VARCHAR2
IS
    v_raw RAW(32);     -- SHA256 trả về 32 byte
    v_hex VARCHAR2(64); -- chuyển sang HEX, 64 ký tự
BEGIN
    -- 1. Tính SHA256
    v_raw := DBMS_CRYPTO.HASH(
                UTL_I18N.STRING_TO_RAW(p_password, 'AL32UTF8'),
                DBMS_CRYPTO.HASH_SH256
             );

    -- 2. RAW -> HEX
    v_hex := RAWTOHEX(v_raw); -- 64 ký tự HEX

    -- 3. Trả về 10 ký tự đầu + 10 ký tự cuối
    RETURN SUBSTR(v_hex, 1, 10) || SUBSTR(v_hex, -10);  
END HASH_PASSWORD_20CHARS;

/
--------------------------------------------------------
--  DDL for Function INVOICE_VPD_PREDICATE
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "APP"."INVOICE_VPD_PREDICATE" (
  p_schema IN VARCHAR2,
  p_object IN VARCHAR2
) RETURN VARCHAR2
AS
  v_role  VARCHAR2(100) := SYS_CONTEXT('APP_CTX','ROLE_NAME');
  v_cus   VARCHAR2(100) := SYS_CONTEXT('APP_CTX','CUSTOMER_PHONE');
BEGIN
  -- ADMIN, TIEPTAN: full
  IF v_role IN ('ROLE_ADMIN', 'ROLE_TIEPTAN') THEN
    RETURN '1=1';
  END IF;

  -- Khách hàng: only own by phone
  IF v_role = 'ROLE_KHACHHANG' THEN
    RETURN 'CUSTOMER_PHONE = ''' || REPLACE(v_cus,'''','''''') || '''';
  END IF;

  -- THUKHO, KITHUATVIEN and others: deny
  RETURN '1=0';
END INVOICE_VPD_PREDICATE;

/
--------------------------------------------------------
--  DDL for Function ORDERS_VPD_PREDICATE
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "APP"."ORDERS_VPD_PREDICATE" (
  p_schema  IN VARCHAR2,
  p_object  IN VARCHAR2
) RETURN VARCHAR2
AS
  v_role VARCHAR2(100) := SYS_CONTEXT('APP_CTX','ROLE_NAME');
  v_emp  VARCHAR2(100) := SYS_CONTEXT('APP_CTX','EMP_ID');
  v_cus  VARCHAR2(100) := SYS_CONTEXT('APP_CTX','CUSTOMER_PHONE');
BEGIN
  IF v_role IS NULL THEN
    RETURN '1=0';
  END IF;

  IF v_role IN ('ROLE_ADMIN','ROLE_TIEPTAN') THEN
    RETURN '1=1';
  END IF;

  IF v_role = 'ROLE_KITHUATVIEN' THEN
    IF v_emp IS NULL THEN
      RETURN '1=0';
    END IF;
    RETURN 'HANDLER_EMP = ' || TO_NUMBER(v_emp);
  END IF;

  IF v_role = 'ROLE_KHACHHANG' THEN
    IF v_cus IS NULL THEN
      RETURN '1=0';
    END IF;
    RETURN 'CUSTOMER_PHONE = ''' || REPLACE(v_cus,'''','''''') || '''';
  END IF;

  IF v_role = 'ROLE_THUKHO' THEN
    RETURN '1=0';
  END IF;

  RETURN '1=0';
END;

/
--------------------------------------------------------
--  DDL for Function ORDERS_VPD_PREDICATE_DEL
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "APP"."ORDERS_VPD_PREDICATE_DEL" (
  p_schema  IN VARCHAR2,
  p_object  IN VARCHAR2
) RETURN VARCHAR2
AS
BEGIN
  RETURN '1=0';
END;

/
--------------------------------------------------------
--  DDL for Function ORDERS_VPD_PREDICATE_UPD
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "APP"."ORDERS_VPD_PREDICATE_UPD" (
  p_schema  IN VARCHAR2,
  p_object  IN VARCHAR2
) RETURN VARCHAR2
AS
  v_role VARCHAR2(100) := SYS_CONTEXT('APP_CTX','ROLE_NAME');
  v_emp  VARCHAR2(100) := SYS_CONTEXT('APP_CTX','EMP_ID');
BEGIN
  IF v_role IS NULL THEN
    RETURN '1=0';
  END IF;

  IF v_role = 'ROLE_ADMIN' THEN
    RETURN '1=1';
  END IF;

  IF v_role = 'ROLE_KITHUATVIEN' THEN
    IF v_emp IS NULL THEN
      RETURN '1=0';
    END IF;
    RETURN 'HANDLER_EMP = ' || TO_NUMBER(v_emp);
  END IF;

  RETURN '1=0';
END;

/
--------------------------------------------------------
--  DDL for Function PARTREQUEST_VPD_PREDICATE
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "APP"."PARTREQUEST_VPD_PREDICATE" (
  p_schema IN VARCHAR2,
  p_object IN VARCHAR2
) RETURN VARCHAR2
AS
  v_role   VARCHAR2(100) := SYS_CONTEXT('APP_CTX','ROLE_NAME');
  v_emp_id VARCHAR2(100) := SYS_CONTEXT('APP_CTX','EMP_ID');
BEGIN
  -- Admin, Thukho: full
  IF v_role IN ('ROLE_ADMIN','ROLE_THUKHO') THEN
    RETURN '1=1';
  END IF;

  -- Kithuatvien: own rows only
  IF v_role = 'ROLE_KITHUATVIEN' THEN
    RETURN 'REQUEST_EMP_ID = TO_NUMBER(''' || REPLACE(v_emp_id,'''','') || ''')';
  END IF;

  -- Tieptan, Khachhang, others: deny
  RETURN '1=0';
END PARTREQUEST_VPD_PREDICATE;

/
--------------------------------------------------------
--  DDL for Function PART_VPD_PREDICATE
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "APP"."PART_VPD_PREDICATE" (
  p_schema IN VARCHAR2,
  p_object IN VARCHAR2
) RETURN VARCHAR2
AS
  v_role  VARCHAR2(100) := SYS_CONTEXT('APP_CTX','ROLE_NAME');
BEGIN
  -- Admin, Thukho, Kithuatvien: full
  IF v_role IN ('ROLE_ADMIN','ROLE_THUKHO','ROLE_KITHUATVIEN') THEN
    RETURN '1=1';
  END IF;

  -- Others (Tieptan, Khachhang, etc.): deny
  RETURN '1=0';
END PART_VPD_PREDICATE;

/
--------------------------------------------------------
--  DDL for Function STOCK_VPD_PREDICATE
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "APP"."STOCK_VPD_PREDICATE" (
  p_schema IN VARCHAR2,
  p_object IN VARCHAR2
) RETURN VARCHAR2
AS
  v_role  VARCHAR2(100) := SYS_CONTEXT('APP_CTX','ROLE_NAME');
BEGIN
  -- ADMIN, THUKHO: xem full
  IF v_role IN ('ROLE_ADMIN', 'ROLE_THUKHO') THEN
    RETURN '1=1';
  END IF;

  -- TIEPTAN, KITHUATVIEN, KHACHHANG: không được xem
  RETURN '1=0';
END STOCK_VPD_PREDICATE;

/
--------------------------------------------------------
--  Constraints for Table INVOICE
--------------------------------------------------------

  ALTER TABLE "APP"."INVOICE" MODIFY ("STOCKOUT_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."INVOICE" MODIFY ("CUSTOMER_PHONE" NOT NULL ENABLE);
  ALTER TABLE "APP"."INVOICE" MODIFY ("EMP_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."INVOICE" ADD PRIMARY KEY ("INVOICE_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  TABLESPACE "USERS"  ENABLE;
--------------------------------------------------------
--  Constraints for Table ORDER_SERVICE
--------------------------------------------------------

  ALTER TABLE "APP"."ORDER_SERVICE" MODIFY ("ORDER_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."ORDER_SERVICE" MODIFY ("SERVICE_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."ORDER_SERVICE" MODIFY ("PRICE" NOT NULL ENABLE);
  ALTER TABLE "APP"."ORDER_SERVICE" ADD CONSTRAINT "PK_ORDERSERVICE" PRIMARY KEY ("ORDER_ID", "SERVICE_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;
--------------------------------------------------------
--  Constraints for Table EMPLOYEE_SHIFT
--------------------------------------------------------

  ALTER TABLE "APP"."EMPLOYEE_SHIFT" MODIFY ("EMP_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."EMPLOYEE_SHIFT" MODIFY ("SHIFT_DATE" NOT NULL ENABLE);
  ALTER TABLE "APP"."EMPLOYEE_SHIFT" MODIFY ("START_TIME" NOT NULL ENABLE);
  ALTER TABLE "APP"."EMPLOYEE_SHIFT" MODIFY ("END_TIME" NOT NULL ENABLE);
  ALTER TABLE "APP"."EMPLOYEE_SHIFT" ADD PRIMARY KEY ("SHIFT_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  TABLESPACE "USERS"  ENABLE;
--------------------------------------------------------
--  Constraints for Table SERVICE
--------------------------------------------------------

  ALTER TABLE "APP"."SERVICE" MODIFY ("SERVICE_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."SERVICE" MODIFY ("NAME" NOT NULL ENABLE);
  ALTER TABLE "APP"."SERVICE" MODIFY ("PRICE" NOT NULL ENABLE);
  ALTER TABLE "APP"."SERVICE" ADD PRIMARY KEY ("SERVICE_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;
--------------------------------------------------------
--  Constraints for Table INVOICE_SERVICE
--------------------------------------------------------

  ALTER TABLE "APP"."INVOICE_SERVICE" MODIFY ("INVOICE_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."INVOICE_SERVICE" MODIFY ("SERVICE_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."INVOICE_SERVICE" MODIFY ("PRICE" NOT NULL ENABLE);
  ALTER TABLE "APP"."INVOICE_SERVICE" ADD CONSTRAINT "PK_INVOICESERVICE" PRIMARY KEY ("INVOICE_ID", "SERVICE_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  TABLESPACE "USERS"  ENABLE;
--------------------------------------------------------
--  Constraints for Table STOCK_IN_ITEM
--------------------------------------------------------

  ALTER TABLE "APP"."STOCK_IN_ITEM" MODIFY ("STOCKIN_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."STOCK_IN_ITEM" MODIFY ("PART_NAME" NOT NULL ENABLE);
  ALTER TABLE "APP"."STOCK_IN_ITEM" MODIFY ("SERIAL" NOT NULL ENABLE);
  ALTER TABLE "APP"."STOCK_IN_ITEM" ADD PRIMARY KEY ("STOCKIN_ITEM_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;
  ALTER TABLE "APP"."STOCK_IN_ITEM" ADD UNIQUE ("SERIAL")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;
--------------------------------------------------------
--  Constraints for Table USER_OTP_LOG
--------------------------------------------------------

  ALTER TABLE "APP"."USER_OTP_LOG" MODIFY ("ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."USER_OTP_LOG" MODIFY ("USER_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."USER_OTP_LOG" MODIFY ("USERNAME" NOT NULL ENABLE);
  ALTER TABLE "APP"."USER_OTP_LOG" MODIFY ("OTP" NOT NULL ENABLE);
  ALTER TABLE "APP"."USER_OTP_LOG" ADD PRIMARY KEY ("ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  TABLESPACE "USERS"  ENABLE;
--------------------------------------------------------
--  Constraints for Table PART
--------------------------------------------------------

  ALTER TABLE "APP"."PART" MODIFY ("NAME" NOT NULL ENABLE);
  ALTER TABLE "APP"."PART" MODIFY ("SERIAL" NOT NULL ENABLE);
  ALTER TABLE "APP"."PART" MODIFY ("STATUS" NOT NULL ENABLE);
  ALTER TABLE "APP"."PART" MODIFY ("STOCK_IN_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."PART" ADD PRIMARY KEY ("PART_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;
  ALTER TABLE "APP"."PART" ADD UNIQUE ("SERIAL")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;
--------------------------------------------------------
--  Constraints for Table CUSTOMER
--------------------------------------------------------

  ALTER TABLE "APP"."CUSTOMER" MODIFY ("FULL_NAME" NOT NULL ENABLE);
  ALTER TABLE "APP"."CUSTOMER" ADD PRIMARY KEY ("PHONE")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;
--------------------------------------------------------
--  Constraints for Table PART_REQUEST_ITEM
--------------------------------------------------------

  ALTER TABLE "APP"."PART_REQUEST_ITEM" MODIFY ("REQUEST_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."PART_REQUEST_ITEM" MODIFY ("PART_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."PART_REQUEST_ITEM" ADD CONSTRAINT "PK_PARTREQUESTITEM" PRIMARY KEY ("REQUEST_ID", "PART_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;
--------------------------------------------------------
--  Constraints for Table STOCK_IN
--------------------------------------------------------

  ALTER TABLE "APP"."STOCK_IN" MODIFY ("EMP_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."STOCK_IN" MODIFY ("IN_DATE" NOT NULL ENABLE);
  ALTER TABLE "APP"."STOCK_IN" ADD PRIMARY KEY ("STOCKIN_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;
--------------------------------------------------------
--  Constraints for Table INVOICE_ITEM
--------------------------------------------------------

  ALTER TABLE "APP"."INVOICE_ITEM" ADD CONSTRAINT "PK_INVOICEITEM" PRIMARY KEY ("INVOICE_ID", "STOCKOUT_ID", "PART_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  TABLESPACE "USERS"  ENABLE;
  ALTER TABLE "APP"."INVOICE_ITEM" ADD CONSTRAINT "UK_INVOICEITEM_STOCKOUT_PART" UNIQUE ("STOCKOUT_ID", "PART_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  TABLESPACE "USERS"  ENABLE;
  ALTER TABLE "APP"."INVOICE_ITEM" MODIFY ("INVOICE_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."INVOICE_ITEM" MODIFY ("STOCKOUT_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."INVOICE_ITEM" MODIFY ("PART_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."INVOICE_ITEM" MODIFY ("PRICE" NOT NULL ENABLE);
--------------------------------------------------------
--  Constraints for Table ORDERS
--------------------------------------------------------

  ALTER TABLE "APP"."ORDERS" MODIFY ("CUSTOMER_PHONE" NOT NULL ENABLE);
  ALTER TABLE "APP"."ORDERS" MODIFY ("RECEIVER_EMP" NOT NULL ENABLE);
  ALTER TABLE "APP"."ORDERS" MODIFY ("HANDLER_EMP" NOT NULL ENABLE);
  ALTER TABLE "APP"."ORDERS" MODIFY ("ORDER_TYPE" NOT NULL ENABLE);
  ALTER TABLE "APP"."ORDERS" MODIFY ("RECEIVED_DATE" NOT NULL ENABLE);
  ALTER TABLE "APP"."ORDERS" MODIFY ("STATUS" NOT NULL ENABLE);
  ALTER TABLE "APP"."ORDERS" ADD PRIMARY KEY ("ORDER_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;
--------------------------------------------------------
--  Constraints for Table STOCK_OUT_ITEM
--------------------------------------------------------

  ALTER TABLE "APP"."STOCK_OUT_ITEM" MODIFY ("STOCKOUT_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."STOCK_OUT_ITEM" MODIFY ("PART_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."STOCK_OUT_ITEM" ADD CONSTRAINT "PK_STOCKOUTITEM" PRIMARY KEY ("STOCKOUT_ID", "PART_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;
--------------------------------------------------------
--  Constraints for Table CUSTOMER_APPOINTMENT
--------------------------------------------------------

  ALTER TABLE "APP"."CUSTOMER_APPOINTMENT" MODIFY ("CUSTOMER_PHONE" NOT NULL ENABLE);
  ALTER TABLE "APP"."CUSTOMER_APPOINTMENT" MODIFY ("APPOINTMENT_DATE" NOT NULL ENABLE);
  ALTER TABLE "APP"."CUSTOMER_APPOINTMENT" ADD PRIMARY KEY ("APPOINTMENT_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  TABLESPACE "USERS"  ENABLE;
--------------------------------------------------------
--  Constraints for Table PART_REQUEST
--------------------------------------------------------

  ALTER TABLE "APP"."PART_REQUEST" MODIFY ("ORDER_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."PART_REQUEST" MODIFY ("EMP_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."PART_REQUEST" MODIFY ("REQUEST_DATE" NOT NULL ENABLE);
  ALTER TABLE "APP"."PART_REQUEST" MODIFY ("STATUS" NOT NULL ENABLE);
  ALTER TABLE "APP"."PART_REQUEST" ADD PRIMARY KEY ("REQUEST_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;
--------------------------------------------------------
--  Constraints for Table STOCK_OUT
--------------------------------------------------------

  ALTER TABLE "APP"."STOCK_OUT" MODIFY ("ORDER_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."STOCK_OUT" MODIFY ("EMP_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."STOCK_OUT" MODIFY ("OUT_DATE" NOT NULL ENABLE);
  ALTER TABLE "APP"."STOCK_OUT" ADD PRIMARY KEY ("STOCKOUT_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;
--------------------------------------------------------
--  Constraints for Table EMPLOYEE
--------------------------------------------------------

  ALTER TABLE "APP"."EMPLOYEE" MODIFY ("EMP_ID" NOT NULL ENABLE);
  ALTER TABLE "APP"."EMPLOYEE" MODIFY ("FULL_NAME" NOT NULL ENABLE);
  ALTER TABLE "APP"."EMPLOYEE" MODIFY ("USERNAME" NOT NULL ENABLE);
  ALTER TABLE "APP"."EMPLOYEE" MODIFY ("PASSWORD_HASH" NOT NULL ENABLE);
  ALTER TABLE "APP"."EMPLOYEE" MODIFY ("EMAIL" NOT NULL ENABLE);
  ALTER TABLE "APP"."EMPLOYEE" MODIFY ("PHONE" NOT NULL ENABLE);
  ALTER TABLE "APP"."EMPLOYEE" ADD PRIMARY KEY ("EMP_ID")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;
  ALTER TABLE "APP"."EMPLOYEE" ADD UNIQUE ("USERNAME")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;
  ALTER TABLE "APP"."EMPLOYEE" ADD UNIQUE ("EMAIL")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;
  ALTER TABLE "APP"."EMPLOYEE" ADD UNIQUE ("PHONE")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1
  BUFFER_POOL DEFAULT FLASH_CACHE DEFAULT CELL_FLASH_CACHE DEFAULT)
  TABLESPACE "USERS"  ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table CUSTOMER_APPOINTMENT
--------------------------------------------------------

  ALTER TABLE "APP"."CUSTOMER_APPOINTMENT" ADD CONSTRAINT "FK_APPOINTMENT_CUSTOMER" FOREIGN KEY ("CUSTOMER_PHONE")
	  REFERENCES "APP"."CUSTOMER" ("PHONE") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table EMPLOYEE_SHIFT
--------------------------------------------------------

  ALTER TABLE "APP"."EMPLOYEE_SHIFT" ADD CONSTRAINT "FK_SHIFT_EMPLOYEE" FOREIGN KEY ("EMP_ID")
	  REFERENCES "APP"."EMPLOYEE" ("EMP_ID") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table INVOICE
--------------------------------------------------------

  ALTER TABLE "APP"."INVOICE" ADD CONSTRAINT "FK_INVOICE_STOCKOUT" FOREIGN KEY ("STOCKOUT_ID")
	  REFERENCES "APP"."STOCK_OUT" ("STOCKOUT_ID") ENABLE;
  ALTER TABLE "APP"."INVOICE" ADD CONSTRAINT "FK_INVOICE_CUSTOMER" FOREIGN KEY ("CUSTOMER_PHONE")
	  REFERENCES "APP"."CUSTOMER" ("PHONE") ENABLE;
  ALTER TABLE "APP"."INVOICE" ADD CONSTRAINT "FK_INVOICE_EMPLOYEE" FOREIGN KEY ("EMP_ID")
	  REFERENCES "APP"."EMPLOYEE" ("EMP_ID") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table INVOICE_ITEM
--------------------------------------------------------

  ALTER TABLE "APP"."INVOICE_ITEM" ADD CONSTRAINT "FK_INVOICEITEM_INVOICE" FOREIGN KEY ("INVOICE_ID")
	  REFERENCES "APP"."INVOICE" ("INVOICE_ID") ENABLE;
  ALTER TABLE "APP"."INVOICE_ITEM" ADD CONSTRAINT "FK_INVOICEITEM_STOCKOUTITEM" FOREIGN KEY ("STOCKOUT_ID", "PART_ID")
	  REFERENCES "APP"."STOCK_OUT_ITEM" ("STOCKOUT_ID", "PART_ID") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table INVOICE_SERVICE
--------------------------------------------------------

  ALTER TABLE "APP"."INVOICE_SERVICE" ADD CONSTRAINT "FK_INVOICESERVICE_INVOICE" FOREIGN KEY ("INVOICE_ID")
	  REFERENCES "APP"."INVOICE" ("INVOICE_ID") ENABLE;
  ALTER TABLE "APP"."INVOICE_SERVICE" ADD CONSTRAINT "FK_INVOICESERVICE_SERVICE" FOREIGN KEY ("SERVICE_ID")
	  REFERENCES "APP"."SERVICE" ("SERVICE_ID") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table ORDERS
--------------------------------------------------------

  ALTER TABLE "APP"."ORDERS" ADD CONSTRAINT "FK_ORDER_CUSTOMER" FOREIGN KEY ("CUSTOMER_PHONE")
	  REFERENCES "APP"."CUSTOMER" ("PHONE") ENABLE;
  ALTER TABLE "APP"."ORDERS" ADD CONSTRAINT "FK_ORDER_EMPLOYEE" FOREIGN KEY ("RECEIVER_EMP")
	  REFERENCES "APP"."EMPLOYEE" ("EMP_ID") ENABLE;
  ALTER TABLE "APP"."ORDERS" ADD CONSTRAINT "FK_ORDER_HANDLEEMPLOYEE" FOREIGN KEY ("HANDLER_EMP")
	  REFERENCES "APP"."EMPLOYEE" ("EMP_ID") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table ORDER_SERVICE
--------------------------------------------------------

  ALTER TABLE "APP"."ORDER_SERVICE" ADD CONSTRAINT "FK_ORDERSERVICE_ORDER" FOREIGN KEY ("ORDER_ID")
	  REFERENCES "APP"."ORDERS" ("ORDER_ID") ENABLE;
  ALTER TABLE "APP"."ORDER_SERVICE" ADD CONSTRAINT "FK_ORDERSERVICE_SERVICE" FOREIGN KEY ("SERVICE_ID")
	  REFERENCES "APP"."SERVICE" ("SERVICE_ID") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table PART
--------------------------------------------------------

  ALTER TABLE "APP"."PART" ADD CONSTRAINT "FK_PART_STOCKINITEM" FOREIGN KEY ("STOCK_IN_ID")
	  REFERENCES "APP"."STOCK_IN" ("STOCKIN_ID") ENABLE;
  ALTER TABLE "APP"."PART" ADD CONSTRAINT "FK_PART_ORDER" FOREIGN KEY ("ORDER_ID")
	  REFERENCES "APP"."ORDERS" ("ORDER_ID") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table PART_REQUEST
--------------------------------------------------------

  ALTER TABLE "APP"."PART_REQUEST" ADD CONSTRAINT "FK_PARTREQUEST_ORDER" FOREIGN KEY ("ORDER_ID")
	  REFERENCES "APP"."ORDERS" ("ORDER_ID") ENABLE;
  ALTER TABLE "APP"."PART_REQUEST" ADD CONSTRAINT "FK_PARTREQUEST_EMPLOYEE" FOREIGN KEY ("EMP_ID")
	  REFERENCES "APP"."EMPLOYEE" ("EMP_ID") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table PART_REQUEST_ITEM
--------------------------------------------------------

  ALTER TABLE "APP"."PART_REQUEST_ITEM" ADD CONSTRAINT "FK_PARTREQUESTITEM_REQUEST" FOREIGN KEY ("REQUEST_ID")
	  REFERENCES "APP"."PART_REQUEST" ("REQUEST_ID") ENABLE;
  ALTER TABLE "APP"."PART_REQUEST_ITEM" ADD CONSTRAINT "FK_PARTREQUESTITEM_PART" FOREIGN KEY ("PART_ID")
	  REFERENCES "APP"."PART" ("PART_ID") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table STOCK_IN
--------------------------------------------------------

  ALTER TABLE "APP"."STOCK_IN" ADD CONSTRAINT "FK_STOCKIN_EMPLOYEE" FOREIGN KEY ("EMP_ID")
	  REFERENCES "APP"."EMPLOYEE" ("EMP_ID") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table STOCK_IN_ITEM
--------------------------------------------------------

  ALTER TABLE "APP"."STOCK_IN_ITEM" ADD CONSTRAINT "FK_STOCKINITEM_STOCKIN" FOREIGN KEY ("STOCKIN_ID")
	  REFERENCES "APP"."STOCK_IN" ("STOCKIN_ID") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table STOCK_OUT
--------------------------------------------------------

  ALTER TABLE "APP"."STOCK_OUT" ADD CONSTRAINT "FK_STOCKOUT_ORDER" FOREIGN KEY ("ORDER_ID")
	  REFERENCES "APP"."ORDERS" ("ORDER_ID") ENABLE;
  ALTER TABLE "APP"."STOCK_OUT" ADD CONSTRAINT "FK_STOCKOUT_EMPLOYEE" FOREIGN KEY ("EMP_ID")
	  REFERENCES "APP"."EMPLOYEE" ("EMP_ID") ENABLE;
--------------------------------------------------------
--  Ref Constraints for Table STOCK_OUT_ITEM
--------------------------------------------------------

  ALTER TABLE "APP"."STOCK_OUT_ITEM" ADD CONSTRAINT "FK_STOCKOUTITEM_STOCKOUT" FOREIGN KEY ("STOCKOUT_ID")
	  REFERENCES "APP"."STOCK_OUT" ("STOCKOUT_ID") ENABLE;
  ALTER TABLE "APP"."STOCK_OUT_ITEM" ADD CONSTRAINT "FK_STOCKOUTITEM_PART" FOREIGN KEY ("PART_ID")
	  REFERENCES "APP"."PART" ("PART_ID") ENABLE;
